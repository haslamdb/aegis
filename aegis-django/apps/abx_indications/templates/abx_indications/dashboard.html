{% extends "abx_indications/base.html" %}

{% block title %}Dashboard - ABX Indication Monitoring{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ABX Indication Monitoring</h1>
    <p>Antibiotic indication documentation and CCHMC guideline concordance</p>
</div>

<!-- Stats Row -->
<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=stats.pending_count title="Pending Review" color="yellow" %}
    {% include "_includes/stat_card.html" with value=stats.red_flag_count title="Red Flags" color="red" %}
    {% include "_includes/stat_card.html" with value=stats.off_guideline_count title="Off Guideline" color="orange" %}
    {% include "_includes/stat_card.html" with value=stats.reviewed_today title="Reviewed Today" color="green" %}
</div>

<!-- Filters -->
<div class="detail-section">
    <div class="detail-section__title" style="display: flex; align-items: center; justify-content: space-between;">
        Pending Queue
        <a href="{% url 'abx_indications:api_export' %}?type=active" class="btn btn--secondary btn--sm">Export CSV</a>
    </div>
    <div class="filter-bar">
        <form method="get" class="filter-form">
            <div class="filter-group">
                <label>Category:</label>
                <select name="category" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if current_filters.category == cat %}selected{% endif %}>{{ cat|title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label>Agent:</label>
                <select name="agent_category" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="first_line" {% if current_filters.agent_category == 'first_line' %}selected{% endif %}>First Line</option>
                    <option value="alternative" {% if current_filters.agent_category == 'alternative' %}selected{% endif %}>Alternative</option>
                    <option value="off_guideline" {% if current_filters.agent_category == 'off_guideline' %}selected{% endif %}>Off Guideline</option>
                    <option value="not_assessed" {% if current_filters.agent_category == 'not_assessed' %}selected{% endif %}>Not Assessed</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Medication:</label>
                <select name="medication" onchange="this.form.submit()">
                    <option value="">All Medications</option>
                    {% for med in medications %}
                    <option value="{{ med }}" {% if current_filters.medication == med %}selected{% endif %}>{{ med }}</option>
                    {% endfor %}
                </select>
            </div>

            {% if current_filters.category or current_filters.agent_category or current_filters.medication %}
            <div class="filter-group">
                <a href="{% url 'abx_indications:dashboard' %}" class="btn btn--secondary btn--sm">Clear</a>
            </div>
            {% endif %}
        </form>
    </div>

    {% if candidates %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Patient</th>
                <th>Medication</th>
                <th>Syndrome</th>
                <th>Confidence</th>
                <th>Agent Category</th>
                <th>Location</th>
                <th>Flags</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for c in candidates %}
            <tr>
                <td>
                    <strong>{{ c.patient_name }}</strong><br>
                    <small style="color: #888;">{{ c.patient_mrn }}</small>
                </td>
                <td>{{ c.medication_name }}</td>
                <td>{{ c.clinical_syndrome_display|default:"Unknown" }}</td>
                <td>
                    {% if c.syndrome_confidence == 'definite' %}
                        {% include "_includes/badge.html" with text=c.syndrome_confidence color="green" %}
                    {% elif c.syndrome_confidence == 'probable' %}
                        {% include "_includes/badge.html" with text=c.syndrome_confidence color="yellow" %}
                    {% else %}
                        {% include "_includes/badge.html" with text=c.syndrome_confidence color="red" %}
                    {% endif %}
                </td>
                <td>
                    {% if c.cchmc_agent_category %}
                        {% include "_includes/badge.html" with text=c.get_cchmc_agent_category_display|default:"\u2014" color=c.cchmc_agent_category|default:"gray" %}
                    {% else %}
                        {% include "_includes/badge.html" with text="\u2014" color="gray" %}
                    {% endif %}
                </td>
                <td>{{ c.location|default:"\u2014" }}</td>
                <td>
                    {% if c.never_appropriate %}{% include "_includes/badge.html" with text="Never" color="red" %}{% endif %}
                    {% if c.likely_viral %}{% include "_includes/badge.html" with text="Viral" color="red" %}{% endif %}
                    {% if c.indication_not_documented %}{% include "_includes/badge.html" with text="No Ind" color="red" %}{% endif %}
                    {% if c.asymptomatic_bacteriuria %}{% include "_includes/badge.html" with text="ASB" color="red" %}{% endif %}
                </td>
                <td>
                    <a href="{% url 'abx_indications:detail' c.id %}" class="btn btn--primary btn--sm">Review</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No pending candidates</h3>
        <p>All antibiotic indications have been reviewed.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
