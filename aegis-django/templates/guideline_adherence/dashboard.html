{% extends "guideline_adherence/base.html" %}

{% block title %}Dashboard - Guideline Adherence{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Guideline Adherence Dashboard</h1>
    <p>Clinical guideline bundle compliance monitoring across 9 evidence-based bundles</p>
</div>

<!-- Stats Row -->
<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=stats.overall_compliance|stringformat:"d"|add:"%" title="Overall Compliance (30d)" color="green" %}
    {% include "_includes/stat_card.html" with value=stats.bundles_tracked title="Bundles Tracked" color="blue" %}
    {% include "_includes/stat_card.html" with value=stats.active_episodes title="Active Episodes" color="teal" %}
    {% include "_includes/stat_card.html" with value=stats.active_alerts title="Active Alerts" color="red" %}
</div>

<!-- Bundle Compliance Cards -->
<div class="section-header">Bundle Compliance (Last 30 Days)</div>
<div class="bundle-grid">
    {% for bs in bundle_stats %}
    <a href="{% url 'guideline_adherence:bundle_detail' bs.bundle.bundle_id %}" class="bundle-card" style="text-decoration: none; color: inherit;">
        <div class="bundle-name">{{ bs.bundle.name }}</div>
        <div class="bundle-stat" style="color: {% if bs.compliance_pct >= 80 %}#28a745{% elif bs.compliance_pct >= 50 %}#d4a017{% else %}#dc3545{% endif %};">
            {{ bs.compliance_pct }}%
        </div>
        <div class="progress-bar" style="margin-bottom: 0.5rem;">
            <div class="progress-fill {% if bs.compliance_pct >= 80 %}green{% elif bs.compliance_pct >= 50 %}amber{% else %}red{% endif %}" style="width: {{ bs.compliance_pct }}%;"></div>
        </div>
        <div class="bundle-meta">
            {{ bs.total_episodes }} completed | {{ bs.active_count }} active
        </div>
    </a>
    {% empty %}
    <div class="empty-state" style="grid-column: 1 / -1;">
        <h3>No bundle data</h3>
        <p>No completed episodes in the last 30 days.</p>
    </div>
    {% endfor %}
</div>

<!-- Recent Active Episodes -->
<div class="detail-section">
    <div class="detail-section__title" style="display: flex; align-items: center; justify-content: space-between;">
        Recent Active Episodes
        <div>
            <a href="{% url 'guideline_adherence:api_export' %}?type=active" class="btn btn--secondary btn--sm">Export CSV</a>
            <a href="{% url 'guideline_adherence:active_episodes' %}" class="btn btn--primary btn--sm" style="margin-left: 0.5rem;">View All</a>
        </div>
    </div>
    {% if active_episodes %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Patient</th>
                <th>Bundle</th>
                <th>Unit</th>
                <th>Trigger</th>
                <th>Adherence</th>
                <th>Elements</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for ep in active_episodes %}
            <tr>
                <td>
                    <strong>{{ ep.patient_name }}</strong><br>
                    <small style="color: #888;">{{ ep.patient_mrn }}</small>
                </td>
                <td>{{ ep.bundle_name }}</td>
                <td>{{ ep.patient_unit|default:"--" }}</td>
                <td>
                    <span style="font-size: 0.85rem;">{{ ep.trigger_description|default:ep.trigger_type|truncatewords:6 }}</span><br>
                    <small style="color: #888;">{{ ep.trigger_time|date:"M d, H:i" }}</small>
                </td>
                <td>
                    {% include "_includes/badge.html" with text=ep.adherence_percentage|stringformat:"d"|add:"%" color=ep.adherence_level %}
                </td>
                <td style="font-size: 0.85rem;">
                    <span style="color: #28a745;">{{ ep.elements_met }}</span> /
                    <span style="color: #dc3545;">{{ ep.elements_not_met }}</span> /
                    <span style="color: #d4a017;">{{ ep.elements_pending }}</span>
                </td>
                <td>
                    {% if ep.review_status == 'pending_review' %}
                        {% include "_includes/badge.html" with text="Pending Review" color="yellow" %}
                    {% elif ep.review_status == 'reviewed' %}
                        {% include "_includes/badge.html" with text="Reviewed" color="green" %}
                    {% else %}
                        {% include "_includes/badge.html" with text="Active" color="blue" %}
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'guideline_adherence:episode_detail' ep.id %}" class="btn btn--primary btn--sm">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No active episodes</h3>
        <p>No guideline bundle episodes are currently being tracked.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
