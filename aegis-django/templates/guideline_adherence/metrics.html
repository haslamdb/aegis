{% extends "guideline_adherence/base.html" %}

{% block title %}Metrics - Guideline Adherence{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Compliance Metrics</h1>
    <p>Adherence rates and review statistics</p>
</div>

<!-- Date Range Filter -->
<div class="detail-section">
    <div class="filter-bar">
        <form method="get" class="filter-form">
            <div class="filter-group">
                <label>Time Period:</label>
                <select name="days" onchange="this.form.submit()">
                    <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                    <option value="14" {% if days == 14 %}selected{% endif %}>Last 14 days</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                    <option value="60" {% if days == 60 %}selected{% endif %}>Last 60 days</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Overall Compliance Stats -->
<div class="stat-cards">
    {% if overall_compliance >= 80 %}
        {% include "_includes/stat_card.html" with value=overall_compliance|stringformat:"d"|add:"%" title="Overall Compliance" color="green" %}
    {% elif overall_compliance >= 50 %}
        {% include "_includes/stat_card.html" with value=overall_compliance|stringformat:"d"|add:"%" title="Overall Compliance" color="yellow" %}
    {% else %}
        {% include "_includes/stat_card.html" with value=overall_compliance|stringformat:"d"|add:"%" title="Overall Compliance" color="red" %}
    {% endif %}
    {% include "_includes/stat_card.html" with value=total title="Total Completed" color="blue" %}
    {% include "_includes/stat_card.html" with value=full title="Full Adherence" color="green" %}
    {% include "_includes/stat_card.html" with value=partial title="Partial Adherence" color="yellow" %}
    {% include "_includes/stat_card.html" with value=low title="Low Adherence" color="red" %}
</div>

<!-- Adherence Distribution -->
{% if total > 0 %}
<div class="detail-section">
    <div class="detail-section__title">Adherence Distribution</div>
    <div style="display: flex; height: 32px; border-radius: 4px; overflow: hidden; margin-bottom: 1rem;">
        {% if full > 0 %}
        <div style="background: #28a745; width: {% widthratio full total 100 %}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
            {{ full }}
        </div>
        {% endif %}
        {% if partial > 0 %}
        <div style="background: #d4a017; width: {% widthratio partial total 100 %}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
            {{ partial }}
        </div>
        {% endif %}
        {% if low > 0 %}
        <div style="background: #dc3545; width: {% widthratio low total 100 %}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;">
            {{ low }}
        </div>
        {% endif %}
    </div>
    <div style="display: flex; gap: 2rem; font-size: 0.85rem;">
        <div><span style="display: inline-block; width: 12px; height: 12px; background: #28a745; border-radius: 2px; margin-right: 0.3rem;"></span> Full ({{ full }})</div>
        <div><span style="display: inline-block; width: 12px; height: 12px; background: #d4a017; border-radius: 2px; margin-right: 0.3rem;"></span> Partial ({{ partial }})</div>
        <div><span style="display: inline-block; width: 12px; height: 12px; background: #dc3545; border-radius: 2px; margin-right: 0.3rem;"></span> Low ({{ low }})</div>
    </div>
</div>
{% endif %}

<!-- Per-Bundle Compliance -->
<div class="detail-section">
    <div class="detail-section__title">Per-Bundle Compliance</div>
    {% if bundle_metrics %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Bundle</th>
                <th>Total Completed</th>
                <th>Full Adherence</th>
                <th>Compliance Rate</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for bm in bundle_metrics %}
            <tr>
                <td>
                    <a href="{% url 'guideline_adherence:bundle_detail' bm.bundle.bundle_id %}" style="font-weight: 600;">
                        {{ bm.bundle.name }}
                    </a>
                </td>
                <td>{{ bm.total }}</td>
                <td style="color: #28a745; font-weight: 600;">{{ bm.full }}</td>
                <td>
                    {% if bm.total > 0 %}
                        {% if bm.compliance_pct >= 80 %}
                            {% include "_includes/badge.html" with text=bm.compliance_pct|stringformat:"d"|add:"%" color="green" %}
                        {% elif bm.compliance_pct >= 50 %}
                            {% include "_includes/badge.html" with text=bm.compliance_pct|stringformat:"d"|add:"%" color="yellow" %}
                        {% else %}
                            {% include "_includes/badge.html" with text=bm.compliance_pct|stringformat:"d"|add:"%" color="red" %}
                        {% endif %}
                    {% else %}
                        {% include "_includes/badge.html" with text="N/A" color="gray" %}
                    {% endif %}
                </td>
                <td style="width: 200px;">
                    {% if bm.total > 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill {% if bm.compliance_pct >= 80 %}green{% elif bm.compliance_pct >= 50 %}amber{% else %}red{% endif %}" style="width: {{ bm.compliance_pct }}%;"></div>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No bundle data</h3>
        <p>No completed episodes in the selected time period.</p>
    </div>
    {% endif %}
</div>

<!-- Review Statistics -->
<div class="detail-section">
    <div class="detail-section__title">Review Statistics</div>
    <div class="stat-cards" style="margin-bottom: 0;">
        {% include "_includes/stat_card.html" with value=review_count title="Total Reviews" color="blue" %}
        {% if override_rate > 20 %}
            {% include "_includes/stat_card.html" with value=override_count title="Overrides" color="red" %}
            {% include "_includes/stat_card.html" with value=override_rate|stringformat:"d"|add:"%" title="Override Rate" color="red" %}
        {% elif override_rate > 10 %}
            {% include "_includes/stat_card.html" with value=override_count title="Overrides" color="yellow" %}
            {% include "_includes/stat_card.html" with value=override_rate|stringformat:"d"|add:"%" title="Override Rate" color="yellow" %}
        {% else %}
            {% include "_includes/stat_card.html" with value=override_count title="Overrides" color="green" %}
            {% include "_includes/stat_card.html" with value=override_rate|stringformat:"d"|add:"%" title="Override Rate" color="green" %}
        {% endif %}
    </div>
</div>
{% endblock %}
