{% extends "mdro/base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h2 style="margin: 0;">MDRO Case Details</h2>
    </div>
    <a href="{% url 'mdro:cases' %}" class="btn btn--secondary">Back to Cases</a>
</div>

<!-- Status badges -->
<div class="status-bar">
    <span class="badge badge-mdro badge-{{ case.mdro_type }} badge-lg">
        {{ case.mdro_type|upper }}
    </span>
    {% if case.transmission_status == 'healthcare' %}
    {% include "_includes/badge.html" with text="Healthcare Onset" color="amber" %}
    {% elif case.transmission_status == 'community' %}
    {% include "_includes/badge.html" with text="Community Onset" color="blue" %}
    {% endif %}
    {% if case.is_new %}
    {% include "_includes/badge.html" with text="New Isolation" color="red" %}
    {% endif %}
</div>

<!-- Two-column layout -->
<div class="detail-layout">
    <!-- Left Column: Patient Context -->
    <div class="detail-layout__sidebar">
        <div class="sidebar-card">
            <h3>Patient Information</h3>
            <div class="field-row"><span class="field-label">Patient Name</span><span class="field-value">{{ case.patient_name|default:"Unknown" }}</span></div>
            <div class="field-row"><span class="field-label">MRN</span><span class="field-value">{{ case.patient_mrn }}</span></div>
            <div class="field-row"><span class="field-label">Unit</span><span class="field-value">{{ case.unit|default:"Unknown" }}</span></div>
            <div class="field-row"><span class="field-label">Facility</span><span class="field-value">{{ case.location|default:"Unknown" }}</span></div>
        </div>

        <div class="sidebar-card">
            <h3>Culture Information</h3>
            <div class="field-row"><span class="field-label">Organism</span><span class="field-value">{{ case.organism }}</span></div>
            <div class="field-row"><span class="field-label">Specimen Type</span><span class="field-value">{{ case.specimen_type|default:"Unknown" }}</span></div>
            <div class="field-row"><span class="field-label">Culture Date</span><span class="field-value">{{ case.culture_date|date:"m/d/Y H:i" }}</span></div>
            <div class="field-row"><span class="field-label">Culture ID</span><span class="field-value" style="font-family: monospace; font-size: 0.85rem;">{{ case.culture_id }}</span></div>
        </div>

        <div class="sidebar-card">
            <h3>Timing &amp; Classification</h3>
            <div class="field-row"><span class="field-label">Admission Date</span><span class="field-value">{% if case.admission_date %}{{ case.admission_date|date:"m/d/Y" }}{% else %}Unknown{% endif %}</span></div>
            <div class="field-row"><span class="field-label">Days Since Admission</span><span class="field-value">{% if case.days_since_admission != None %}{{ case.days_since_admission }}{% else %}Unknown{% endif %}</span></div>
            <div class="field-row"><span class="field-label">Transmission</span><span class="field-value">{{ case.get_transmission_status_display }}</span></div>
            <div class="field-row"><span class="field-label">New Isolation</span><span class="field-value">{% if case.is_new %}Yes{% else %}No (Previously known){% endif %}</span></div>
        </div>

        <div class="sidebar-card">
            <h3>Case Status</h3>
            <div class="field-row"><span class="field-label">Prior MDRO History</span><span class="field-value">{% if case.prior_history %}Yes{% else %}No{% endif %}</span></div>
            <div class="field-row"><span class="field-label">Created</span><span class="field-value">{{ case.created_at|date:"m/d/Y H:i" }}</span></div>
            <div class="field-row"><span class="field-label">Reviewed By</span><span class="field-value">{% if case.reviewed_by %}{{ case.reviewed_by.username }}{% else %}Not yet reviewed{% endif %}</span></div>
            <div class="field-row"><span class="field-label">Reviewed At</span><span class="field-value">{% if case.reviewed_at %}{{ case.reviewed_at|date:"m/d/Y H:i" }}{% else %}---{% endif %}</span></div>
        </div>
    </div>

    <!-- Right Column: Details + Actions -->
    <div class="detail-layout__main">
        <!-- Resistance Profile -->
        <div class="detail-section">
            <h3>Resistance Profile</h3>
            <div class="classification-summary">
                <span class="badge badge-mdro badge-{{ case.mdro_type }} badge-lg">
                    {{ case.mdro_type|upper }}
                </span>
                <span class="classification-text">{{ case.classification_reason }}</span>
            </div>

            {% if case.susceptibilities %}
            <div class="susceptibility-section">
                <h4>Susceptibility Results</h4>
                <table class="data-table susceptibility-table">
                    <thead>
                        <tr>
                            <th>Antibiotic</th>
                            <th>Result</th>
                            <th>MIC</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for susc in case.susceptibilities %}
                        <tr class="susc-row susc-{{ susc.result|lower }}">
                            <td>{{ susc.antibiotic|capfirst }}</td>
                            <td>
                                <div class="susc-result">
                                    <span class="susc-badge susc-{{ susc.result|lower }}">{{ susc.result }}</span>
                                    <span class="susc-text">
                                        {% if susc.result == 'R' %}Resistant
                                        {% elif susc.result == 'I' %}Intermediate
                                        {% elif susc.result == 'S' %}Susceptible
                                        {% else %}{{ susc.result }}{% endif %}
                                    </span>
                                </div>
                            </td>
                            <td class="mic-value">{{ susc.mic|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% elif case.resistant_antibiotics %}
            <div class="susceptibility-section">
                <h4>Resistant Antibiotics</h4>
                <table class="data-table susceptibility-table">
                    <thead>
                        <tr><th>Antibiotic</th><th>Result</th></tr>
                    </thead>
                    <tbody>
                        {% for abx in case.resistant_antibiotics %}
                        <tr class="susc-row susc-r">
                            <td>{{ abx|capfirst }}</td>
                            <td>
                                <div class="susc-result">
                                    <span class="susc-badge susc-r">R</span>
                                    <span class="susc-text">Resistant</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>

        <!-- Prior MDRO History -->
        {% if prior_cases %}
        <div class="detail-section">
            <h3>Patient's Prior MDRO History</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>MDRO Type</th>
                        <th>Organism</th>
                        <th>Specimen</th>
                        <th>Unit</th>
                        <th>Culture Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prior in prior_cases %}
                    <tr>
                        <td>
                            <span class="badge badge-mdro badge-{{ prior.mdro_type }}">
                                {{ prior.mdro_type|upper }}
                            </span>
                        </td>
                        <td>{{ prior.organism }}</td>
                        <td>{{ prior.specimen_type|default:"-" }}</td>
                        <td>{{ prior.unit|default:"-" }}</td>
                        <td>{{ prior.culture_date|date:"Y-m-d" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- IP Review Actions -->
        {% if not case.reviewed_by %}
        <div class="detail-section">
            <h3>Classification Decision</h3>
            <div class="form-group">
                <label for="reviewer">Reviewer Name</label>
                <input type="text" id="reviewer" class="form-control" placeholder="Enter your name" value="{{ request.user.get_full_name|default:request.user.username }}">
            </div>

            <div class="classification-buttons-single">
                <button type="button" class="btn btn--danger btn-block" data-decision="confirmed">
                    Confirm {{ case.mdro_type|upper }}
                </button>
            </div>

            <div class="classification-divider"><span>Or:</span></div>

            <div class="secondary-buttons">
                <button type="button" class="btn btn--success btn-block" data-decision="rejected">
                    Not {{ case.mdro_type|upper }}
                </button>
                <button type="button" class="btn btn--secondary btn-block" data-decision="needs_more_info">
                    Needs More Info
                </button>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label for="notes">Notes (optional)</label>
                <textarea name="notes" id="notes" rows="3" class="form-textarea" placeholder="Additional details..."></textarea>
            </div>

            <div id="review-result" class="hidden"></div>
        </div>
        {% else %}
        <!-- Already reviewed -->
        <div class="detail-section">
            <h3>Classification Complete</h3>
            <div class="review-complete">
                <span class="status-icon">&#x2713;</span>
                <strong>Case Reviewed</strong>
                <p>This case has been reviewed by {{ case.reviewed_by.username }}.</p>
                <p class="reviewer-info">{{ case.reviewed_at|date:"Y-m-d H:i" }}</p>
                {% if case.notes %}
                <p class="review-notes-display">{{ case.notes }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="action-bar">
            <a href="{% url 'mdro:cases' %}" class="btn btn--secondary">&larr; Back to Cases</a>
            <a href="{% url 'mdro:dashboard' %}" class="btn btn--secondary">Dashboard</a>
        </div>
    </div>
</div>

<script>
(function() {
    async function submitReview(decision) {
        const reviewer = document.getElementById('reviewer').value;
        const notes = document.getElementById('notes').value;
        const resultDiv = document.getElementById('review-result');

        if (!reviewer.trim()) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Please enter your name</div>';
            resultDiv.classList.remove('hidden');
            document.getElementById('reviewer').focus();
            return;
        }

        const data = new URLSearchParams({
            reviewer: reviewer,
            decision: decision,
            notes: notes,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        });

        try {
            const response = await fetch('{% url "mdro:review_case" case.id %}', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: data
            });

            const result = await response.json();

            if (result.success) {
                resultDiv.innerHTML = '<div class="alert alert-success">Classification submitted! Redirecting...</div>';
                resultDiv.classList.remove('hidden');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + result.error + '</div>';
                resultDiv.classList.remove('hidden');
            }
        } catch (err) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Failed to submit: ' + err.message + '</div>';
            resultDiv.classList.remove('hidden');
        }
    }

    document.querySelectorAll('.classification-buttons-single button, .secondary-buttons button').forEach(btn => {
        btn.addEventListener('click', function() {
            const decision = this.getAttribute('data-decision');
            document.querySelectorAll('.classification-buttons-single button, .secondary-buttons button').forEach(b => {
                b.classList.remove('selected');
            });
            this.classList.add('selected');
            submitReview(decision);
        });
    });
})();
</script>
{% endblock %}
