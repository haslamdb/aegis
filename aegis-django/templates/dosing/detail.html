{% extends "dosing/base.html" %}

{% block content %}
<h2>Dosing Alert Detail</h2>

<div class="detail-layout">
    {# Left sidebar: Patient Factors #}
    <div class="detail-sidebar">
        <div class="sidebar-card">
            <h4>Patient Information</h4>
            {% if alert.patient_name %}
            <p><span class="label">Name:</span> {{ alert.patient_name }}</p>
            <p><span class="label">MRN:</span> {{ alert.patient_mrn }}</p>
            {% if alert.patient_location %}
            <p><span class="label">Location:</span> {{ alert.patient_location }}</p>
            {% endif %}
            {% if alert.details.encounter_id %}
            <p><span class="label">Encounter:</span> {{ alert.details.encounter_id }}</p>
            {% endif %}
            {% else %}
            <p>No patient information available</p>
            {% endif %}
        </div>

        {% if patient_factors %}
        <div class="sidebar-card">
            <h4>Patient Factors</h4>
            {% if patient_factors.age_years != None %}
            <p><span class="label">Age:</span> {{ patient_factors.age_years }} years</p>
            {% endif %}
            {% if patient_factors.weight_kg %}
            <p><span class="label">Weight:</span> {{ patient_factors.weight_kg }} kg</p>
            {% endif %}
            {% if patient_factors.height_cm %}
            <p><span class="label">Height:</span> {{ patient_factors.height_cm }} cm</p>
            {% endif %}
            {% if patient_factors.bsa %}
            <p><span class="label">BSA:</span> {{ patient_factors.bsa }} m&sup2;</p>
            {% endif %}
        </div>

        {% if patient_factors.scr or patient_factors.gfr %}
        <div class="sidebar-card">
            <h4>Renal Function</h4>
            {% if patient_factors.scr %}
            <p><span class="label">SCr:</span> {{ patient_factors.scr }} mg/dL</p>
            {% endif %}
            {% if patient_factors.gfr %}
            <p><span class="label">eGFR:</span> {{ patient_factors.gfr }} mL/min</p>
            {% endif %}
            {% if patient_factors.crcl %}
            <p><span class="label">CrCl:</span> {{ patient_factors.crcl }} mL/min</p>
            {% endif %}
            {% if patient_factors.is_on_dialysis %}
            <p><span class="label">Dialysis:</span> <span style="color: #e74c3c; font-weight: bold;">Yes</span></p>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}

        {% if details.medications %}
        <div class="sidebar-card">
            <h4>Current Antimicrobials</h4>
            {% for med in details.medications %}
            <div style="padding: 6px 0; border-bottom: 1px solid #eee; font-size: 13px;">
                <strong>{{ med.drug_name }}</strong><br>
                <small style="color: #7f8c8d;">
                    {{ med.dose_value }} {{ med.dose_unit }} {{ med.route }} {{ med.interval }}
                </small>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if details.co_medications %}
        <div class="sidebar-card">
            <h4>Co-Medications</h4>
            {% for med in details.co_medications %}
            <div style="padding: 4px 0; font-size: 13px;">
                {{ med.drug_name|default:med }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if details.allergies %}
        <div class="sidebar-card">
            <h4>Allergies</h4>
            {% for allergy in details.allergies %}
            <div style="padding: 4px 0; font-size: 13px;">
                <span class="badge" style="background: {% if allergy.severity == 'severe' %}#e74c3c{% elif allergy.severity == 'moderate' %}#f39c12{% else %}#3498db{% endif %}; font-size: 10px;">
                    {{ allergy.severity|upper|default:"UNKNOWN" }}
                </span>
                {{ allergy.drug|default:allergy }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {# Right main area: Dosing Issue + Actions #}
    <div class="detail-main">
        {# Status bar #}
        <div style="margin-bottom: 15px;">
            <span class="badge {{ alert.severity|lower }}">{{ alert.get_severity_display }}</span>
            <span class="badge {{ alert.status|lower }}">{{ alert.get_status_display }}</span>
            <span class="badge" style="background: #8e44ad;">{{ alert.get_alert_type_display }}</span>
        </div>

        {# Dosing Issue card #}
        <div class="dose-comparison">
            <h3 style="margin-top: 0; color: #2c3e50;">{{ alert.title }}</h3>

            {% if details.drug %}
            <p><strong>Drug:</strong> {{ details.drug }}</p>
            {% endif %}
            {% if details.indication %}
            <p><strong>Indication:</strong> {{ details.indication }}</p>
            {% endif %}
            {% if details.flag_type %}
            <p><strong>Issue Type:</strong> {{ details.flag_type_display|default:details.flag_type }}</p>
            {% endif %}

            <p style="color: #555; margin: 10px 0;">{{ alert.summary }}</p>

            {% if details.actual_dose %}
            <div class="dose-actual">
                <strong style="color: #e74c3c;">Actual:</strong> {{ details.actual_dose }}
            </div>
            {% endif %}

            {% if details.expected_dose %}
            <div class="dose-expected">
                <strong style="color: #27ae60;">Expected:</strong> {{ details.expected_dose }}
            </div>
            {% endif %}

            {% if details.rule_source %}
            <p style="font-size: 13px; color: #7f8c8d; margin-top: 10px;">
                <strong>Source:</strong> {{ details.rule_source }}
            </p>
            {% endif %}

            {% if details.clinical_note %}
            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #f39c12;">
                <strong>Clinical Note:</strong> {{ details.clinical_note }}
            </div>
            {% endif %}
        </div>

        {# All Flags in Assessment #}
        {% if all_flags|length > 1 %}
        <div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 15px 0;">
            <h3 style="margin-top: 0;">All Flags in Assessment ({{ all_flags|length }})</h3>
            <table style="margin: 10px 0;">
                <tr>
                    <th>Severity</th>
                    <th>Type</th>
                    <th>Drug</th>
                    <th>Issue</th>
                </tr>
                {% for flag in all_flags %}
                <tr>
                    <td><span class="badge {{ flag.severity|lower }}">{{ flag.severity|upper }}</span></td>
                    <td>{{ flag.flag_type_display }}</td>
                    <td>{{ flag.drug }}</td>
                    <td>{{ flag.message|truncatewords:20 }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}

        {# Actions #}
        {% if alert.status != 'resolved' %}
        <div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 15px 0;">
            <h3 style="margin-top: 0;">Actions</h3>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                {% if alert.status == 'pending' or alert.status == 'sent' %}
                <form method="post" action="{% url 'dosing:api_acknowledge' alert.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Acknowledge</button>
                </form>
                {% endif %}

                <button onclick="document.getElementById('resolve-form').style.display='block'; this.style.display='none';"
                        class="btn btn-danger">Resolve</button>
            </div>

            <div id="resolve-form" style="display: none;">
                <form method="post" action="{% url 'dosing:api_resolve' alert.id %}">
                    {% csrf_token %}
                    <label><strong>Resolution Reason:</strong></label>
                    <select name="reason" required style="width: 100%; padding: 5px; margin: 5px 0;">
                        <option value="">Select reason...</option>
                        {% for value, label in resolution_reasons %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <label><strong>Notes:</strong></label>
                    <textarea name="notes" rows="3" style="width: 100%; padding: 5px; margin: 5px 0;"
                              placeholder="Clinical rationale for resolution..."></textarea>
                    <button type="submit" class="btn btn-danger">Confirm Resolution</button>
                    <button type="button" onclick="document.getElementById('resolve-form').style.display='none';"
                            class="btn" style="background: #95a5a6; color: white; margin-left: 5px;">Cancel</button>
                </form>
            </div>
        </div>
        {% else %}
        <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 5px solid #27ae60;">
            <h4 style="margin-top: 0;">Resolved</h4>
            <p><strong>Reason:</strong> {{ alert.get_resolution_reason_display }}</p>
            {% if alert.resolution_notes %}
            <p><strong>Notes:</strong> {{ alert.resolution_notes }}</p>
            {% endif %}
            <p><strong>By:</strong> {{ alert.resolved_by.username|default:"System" }} at {{ alert.resolved_at|date:"Y-m-d H:i:s" }}</p>
        </div>
        {% endif %}

        {# Add Note #}
        <div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 15px 0;">
            <h4 style="margin-top: 0;">Add Note</h4>
            <form method="post" action="{% url 'dosing:api_note' alert.id %}">
                {% csrf_token %}
                <textarea name="note" rows="3" placeholder="Add a clinical note..."
                          style="width: 100%; padding: 5px; margin-bottom: 5px;"></textarea>
                <button type="submit" class="btn btn-primary">Add Note</button>
            </form>
        </div>

        {# Existing Notes #}
        {% if alert.details.notes %}
        <div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 15px 0;">
            <h4 style="margin-top: 0;">Notes</h4>
            {% for note in alert.details.notes %}
            <div style="padding: 8px; background: #f8f9fa; border-radius: 3px; margin-bottom: 8px; font-size: 13px;">
                <strong>{{ note.user }}</strong> <span style="color: #7f8c8d;">{{ note.timestamp }}</span>
                <p style="margin: 5px 0 0 0;">{{ note.text }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Timeline #}
        <div style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 15px 0;">
            <h4 style="margin-top: 0;">Timeline</h4>
            <p><strong>Created:</strong> {{ alert.created_at|date:"Y-m-d H:i:s" }}</p>
            {% if alert.acknowledged_at %}
            <p><strong>Acknowledged:</strong> {{ alert.acknowledged_at|date:"Y-m-d H:i:s" }}
            {% if alert.acknowledged_by %}by {{ alert.acknowledged_by.username }}{% endif %}</p>
            {% endif %}
            {% if alert.resolved_at %}
            <p><strong>Resolved:</strong> {{ alert.resolved_at|date:"Y-m-d H:i:s" }}
            {% if alert.resolved_by %}by {{ alert.resolved_by.username }}{% endif %}</p>
            {% endif %}
        </div>

        {# Audit Log #}
        <h3>Audit Log</h3>
        {% if audit_log %}
        <div>
            {% for entry in audit_log %}
            <div class="audit-log">
                <strong>{{ entry.performed_at|date:"Y-m-d H:i:s" }}</strong> -
                <span class="badge" style="background: #34495e;">{{ entry.action }}</span>
                {% if entry.performed_by %}by {{ entry.performed_by.username }}{% endif %}
                {% if entry.old_status %}<br><small>{{ entry.old_status }} &rarr; {{ entry.new_status }}</small>{% endif %}
                {% if entry.details.notes %}<br><small>{{ entry.details.notes }}</small>{% endif %}
                {% if entry.details.note %}<br><small>Note: {{ entry.details.note }}</small>{% endif %}
                {% if entry.details.reason %}<br><small>Reason: {{ entry.details.reason }}</small>{% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No audit log entries</p>
        {% endif %}

        <div style="margin-top: 20px;">
            <a href="{% url 'dosing:dashboard' %}" class="btn btn-primary">&larr; Back to Dashboard</a>
        </div>
    </div>
</div>

{% endblock %}
