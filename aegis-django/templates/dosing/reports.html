{% extends "dosing/base.html" %}

{% block content %}
<h2>Dosing Verification Analytics (Last {{ days }} days)</h2>

<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label>Time Period:</label>
            <select name="days" onchange="this.form.submit()">
                <option value="7" {% if days == 7 %}selected{% endif %}>7 days</option>
                <option value="14" {% if days == 14 %}selected{% endif %}>14 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>30 days</option>
                <option value="60" {% if days == 60 %}selected{% endif %}>60 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>90 days</option>
            </select>
        </div>
    </form>
</div>

<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=total_alerts title="Total Alerts" color="blue" %}
    {% include "_includes/stat_card.html" with value=active_count title="Active" color="teal" %}
    {% include "_includes/stat_card.html" with value=resolved_count title="Resolved" color="green" %}
    {% include "_includes/stat_card.html" with value=action_rate|stringformat:"d" title="Action Rate %" color="purple" %}
</div>

<h3>Alerts by Severity</h3>
<table class="data-table">
    <tr>
        <th>Severity</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    {% for item in by_severity %}
    <tr>
        <td>{% include "_includes/badge.html" with text=item.severity|upper color=item.severity|lower %}</td>
        <td>{{ item.count }}</td>
        <td>{% if total_alerts > 0 %}{% widthratio item.count total_alerts 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="3" style="text-align: center;">No data available</td>
    </tr>
    {% endfor %}
</table>

<h3>Alerts by Type</h3>
<table class="data-table">
    <tr>
        <th>Alert Type</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    {% for item in by_type %}
    <tr>
        <td>{{ item.alert_type }}</td>
        <td>{{ item.count }}</td>
        <td>{% if total_alerts > 0 %}{% widthratio item.count total_alerts 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="3" style="text-align: center;">No data available</td>
    </tr>
    {% endfor %}
</table>

{% if top_drugs %}
<h3>Top Flagged Drugs</h3>
<table class="data-table">
    <tr>
        <th>Drug</th>
        <th>Alerts</th>
        <th>Percentage</th>
    </tr>
    {% for drug_name, drug_count in top_drugs %}
    <tr>
        <td><strong>{{ drug_name }}</strong></td>
        <td>{{ drug_count }}</td>
        <td>{% if total_alerts > 0 %}{% widthratio drug_count total_alerts 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% if by_resolution %}
<h3>Resolution Reasons ({{ resolved_count }} resolved)</h3>
<table class="data-table">
    <tr>
        <th>Resolution Reason</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    {% for item in by_resolution %}
    <tr>
        <td>{{ item.resolution_reason|default:"Not Specified" }}</td>
        <td>{{ item.count }}</td>
        <td>{% if resolved_count > 0 %}{% widthratio item.count resolved_count 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}

<h3>Clinical Impact</h3>
<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=dose_adjusted title="Doses Adjusted" color="green" %}
    {% include "_includes/stat_card.html" with value=interval_adjusted title="Intervals Adjusted" color="blue" %}
    {% include "_includes/stat_card.html" with value=route_changed title="Routes Changed" color="purple" %}
    {% include "_includes/stat_card.html" with value=therapy_changed title="Therapies Changed" color="amber" %}
</div>

{% endblock %}
