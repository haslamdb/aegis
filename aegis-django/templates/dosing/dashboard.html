{% extends "dosing/base.html" %}

{% block content %}
<h2>Active Dosing Alerts</h2>

<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=stats.active_count title="Active Alerts" color="blue" %}
    {% include "_includes/stat_card.html" with value=stats.critical_count title="Critical" color="red" %}
    {% include "_includes/stat_card.html" with value=stats.high_count title="High" color="amber" %}
    {% include "_includes/stat_card.html" with value=stats.resolved_today title="Resolved Today" color="green" %}
</div>

<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label>Severity:</label>
            <select name="severity" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="critical" {% if current_filters.severity == 'critical' %}selected{% endif %}>Critical</option>
                <option value="high" {% if current_filters.severity == 'high' %}selected{% endif %}>High</option>
                <option value="medium" {% if current_filters.severity == 'medium' %}selected{% endif %}>Medium</option>
                <option value="low" {% if current_filters.severity == 'low' %}selected{% endif %}>Low</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Alert Type:</label>
            <select name="type" onchange="this.form.submit()">
                <option value="">All Types</option>
                {% for type_value, type_label in dosing_alert_types %}
                <option value="{{ type_value }}" {% if current_filters.type == type_value %}selected{% endif %}>
                    {{ type_label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Flag Type:</label>
            <select name="flag_type" onchange="this.form.submit()">
                <option value="">All Flags</option>
                {% for flag_value, flag_label in flag_type_options %}
                <option value="{{ flag_value }}" {% if current_filters.flag_type == flag_value %}selected{% endif %}>
                    {{ flag_label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Drug:</label>
            <select name="drug" onchange="this.form.submit()">
                <option value="">All Drugs</option>
                {% for d in drug_list %}
                <option value="{{ d }}" {% if current_filters.drug == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <button type="submit" class="btn btn--primary">Apply</button>
            {% if current_filters.severity or current_filters.type or current_filters.flag_type or current_filters.drug %}
            <a href="{% url 'dosing:dashboard' %}" class="btn btn--secondary">Clear</a>
            {% endif %}
        </div>
    </form>
</div>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <p><strong>{{ alerts|length }}</strong> active alert{{ alerts|length|pluralize }}</p>
    <a href="{% url 'dosing:export_active' %}" class="btn btn--primary" style="font-size: 12px;">Export CSV</a>
</div>

<table class="data-table">
    <tr>
        <th>Severity</th>
        <th>Patient</th>
        <th>Drug</th>
        <th>Issue</th>
        <th>Expected vs Actual</th>
        <th>Created</th>
        <th>Actions</th>
    </tr>
    {% for alert in alerts %}
    <tr>
        <td>{% include "_includes/badge.html" with text=alert.get_severity_display color=alert.severity|lower %}</td>
        <td>
            {% if alert.patient_name %}
                {{ alert.patient_name }}<br>
                <small class="text-muted">MRN: {{ alert.patient_mrn }}{% if alert.patient_location %} | {{ alert.patient_location }}{% endif %}</small>
            {% else %}
                Unknown
            {% endif %}
        </td>
        <td><strong>{{ alert.details.drug|default:"--" }}</strong></td>
        <td>
            {% include "_includes/badge.html" with text=alert.get_alert_type_display color="purple" %}
            <br><small>{{ alert.summary|truncatewords:15 }}</small>
        </td>
        <td>
            {% if alert.details.expected_dose %}
            <small style="color: #27ae60;">Expected: {{ alert.details.expected_dose|truncatewords:8 }}</small><br>
            <small style="color: #e74c3c;">Actual: {{ alert.details.actual_dose|truncatewords:8 }}</small>
            {% else %}
            <small class="text-muted">--</small>
            {% endif %}
        </td>
        <td><small>{{ alert.created_at|date:"Y-m-d H:i" }}</small></td>
        <td>
            <a href="{% url 'dosing:detail' alert.id %}" class="btn btn--primary" style="font-size: 12px; padding: 5px 10px;">
                Review
            </a>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="7" style="text-align: center; padding: 30px;">
            No active dosing alerts found.
        </td>
    </tr>
    {% endfor %}
</table>

{% endblock %}
