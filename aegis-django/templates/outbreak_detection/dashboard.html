{% extends "outbreak_detection/base.html" %}

{% block content %}
<h2>Cluster Detection & Investigation</h2>

<div class="stats-row">
    <div class="stat-box active-stat">
        <div class="stat-value">{{ stats.active_clusters }}</div>
        <div class="stat-label">Active Clusters</div>
    </div>
    <div class="stat-box investigating-stat">
        <div class="stat-value">{{ stats.investigating_clusters }}</div>
        <div class="stat-label">Investigating</div>
    </div>
    <div class="stat-box resolved-stat">
        <div class="stat-value">{{ stats.resolved_clusters }}</div>
        <div class="stat-label">Resolved</div>
    </div>
    <div class="stat-box alert-stat">
        <div class="stat-value">{{ stats.pending_alerts }}</div>
        <div class="stat-label">Pending Alerts</div>
    </div>
</div>

<!-- Severity Grid -->
{% if stats.by_severity %}
<div class="section">
    <h2>Active Clusters by Severity</h2>
    <div class="severity-grid">
        <div class="severity-card severity-critical {% if not stats.by_severity.critical %}severity-empty{% endif %}">
            <div class="severity-count">{{ stats.by_severity.critical|default:"0" }}</div>
            <div class="severity-label">Critical</div>
        </div>
        <div class="severity-card severity-high {% if not stats.by_severity.high %}severity-empty{% endif %}">
            <div class="severity-count">{{ stats.by_severity.high|default:"0" }}</div>
            <div class="severity-label">High</div>
        </div>
        <div class="severity-card severity-medium {% if not stats.by_severity.medium %}severity-empty{% endif %}">
            <div class="severity-count">{{ stats.by_severity.medium|default:"0" }}</div>
            <div class="severity-label">Medium</div>
        </div>
        <div class="severity-card severity-low {% if not stats.by_severity.low %}severity-empty{% endif %}">
            <div class="severity-count">{{ stats.by_severity.low|default:"0" }}</div>
            <div class="severity-label">Low</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Pending Alerts -->
{% if pending_alerts %}
<div class="section">
    <h2>Pending Alerts</h2>
    {% for alert in pending_alerts %}
    <div class="alert-box {{ alert.severity }}">
        <strong>{{ alert.title }}</strong>
        <p>{{ alert.summary }}</p>
        <small class="text-muted">{{ alert.created_at|date:"Y-m-d H:i" }}</small>
        {% if alert.details.cluster_id %}
        | <a href="{% url 'outbreak_detection:cluster_detail' alert.details.cluster_id %}">View Cluster</a>
        {% endif %}
    </div>
    {% endfor %}
    {% if pending_alerts|length > 5 %}
    <p class="text-center">
        <a href="{% url 'outbreak_detection:alerts_list' %}">View all alerts</a>
    </p>
    {% endif %}
</div>
{% endif %}

<!-- Active Clusters Table -->
<div class="section">
    <h2>Active Outbreak Clusters</h2>
    {% if active_clusters %}
    <table>
        <tr>
            <th>Unit</th>
            <th>Infection Type</th>
            <th>Organism</th>
            <th style="text-align: center;">Cases</th>
            <th style="text-align: center;">Severity</th>
            <th>Status</th>
            <th>First Case</th>
            <th>Last Case</th>
            <th style="text-align: center;">Actions</th>
        </tr>
        {% for cluster in active_clusters %}
        <tr>
            <td><strong>{{ cluster.unit }}</strong></td>
            <td><span class="badge" style="background: #4a1942;">{{ cluster.infection_type|upper }}</span></td>
            <td>{{ cluster.organism|default:"-" }}</td>
            <td style="text-align: center;"><strong>{{ cluster.case_count }}</strong></td>
            <td style="text-align: center;">
                <span class="badge {{ cluster.severity }}">{{ cluster.get_severity_display }}</span>
            </td>
            <td>
                <span class="badge {{ cluster.status }}">{{ cluster.get_status_display }}</span>
            </td>
            <td>{{ cluster.first_case_date|date:"Y-m-d"|default:"-" }}</td>
            <td>{{ cluster.last_case_date|date:"Y-m-d"|default:"-" }}</td>
            <td style="text-align: center;">
                <a href="{% url 'outbreak_detection:cluster_detail' cluster.id %}" class="btn btn-primary btn-sm">View</a>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="action-card" style="text-align: center; padding: 40px;">
        <h3>No Active Clusters</h3>
        <p class="text-muted">No outbreak clusters currently active. This is good news!</p>
    </div>
    {% endif %}
</div>

{% endblock %}
