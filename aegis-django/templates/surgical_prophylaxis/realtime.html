{% extends "surgical_prophylaxis/base.html" %}

{% block content %}
<h2>Real-time Surgical Monitoring</h2>

<!-- Active Journeys -->
<div class="section">
    <h2>Active Journeys ({{ active_journeys|length }})</h2>
    {% if active_journeys %}
    <table>
        <tr>
            <th>Patient</th>
            <th>Procedure</th>
            <th style="text-align: center;">State</th>
            <th>Scheduled</th>
            <th style="text-align: center;">Order</th>
            <th style="text-align: center;">Given</th>
            <th style="text-align: center;">T-24</th>
            <th style="text-align: center;">T-2</th>
            <th style="text-align: center;">T-60</th>
            <th style="text-align: center;">T-0</th>
        </tr>
        {% for j in active_journeys %}
        <tr>
            <td><strong>{{ j.patient_mrn }}</strong><br><small>{{ j.patient_name }}</small></td>
            <td>{{ j.procedure_description|truncatechars:30|default:"-" }}</td>
            <td style="text-align: center;">
                <span class="badge {{ j.current_state }}">{{ j.get_current_state_display }}</span>
            </td>
            <td>{{ j.scheduled_time|date:"Y-m-d H:i"|default:"-" }}</td>
            <td style="text-align: center;">
                {% if j.order_exists %}<span style="color: #27ae60; font-weight: bold;">Yes</span>{% else %}<span style="color: #e74c3c;">No</span>{% endif %}
            </td>
            <td style="text-align: center;">
                {% if j.administered %}<span style="color: #27ae60; font-weight: bold;">Yes</span>{% else %}<span style="color: #e74c3c;">No</span>{% endif %}
            </td>
            <td style="text-align: center;">{% if j.alert_t24_sent %}<span style="color: #f39c12;" title="{{ j.alert_t24_time|date:'H:i' }}">Sent</span>{% else %}-{% endif %}</td>
            <td style="text-align: center;">{% if j.alert_t2_sent %}<span style="color: #e67e22;" title="{{ j.alert_t2_time|date:'H:i' }}">Sent</span>{% else %}-{% endif %}</td>
            <td style="text-align: center;">{% if j.alert_t60_sent %}<span style="color: #e74c3c;" title="{{ j.alert_t60_time|date:'H:i' }}">Sent</span>{% else %}-{% endif %}</td>
            <td style="text-align: center;">{% if j.alert_t0_sent %}<span style="color: #e74c3c; font-weight: bold;" title="{{ j.alert_t0_time|date:'H:i' }}">Sent</span>{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="action-card" style="text-align: center; padding: 40px;">
        <h3>No Active Journeys</h3>
        <p class="text-muted">No patients currently being tracked through the surgical pathway.</p>
    </div>
    {% endif %}
</div>

<!-- Pending Escalations -->
{% if pending_escalations %}
<div class="section">
    <h2>Pending Escalations</h2>
    <table>
        <tr>
            <th>Patient</th>
            <th>Trigger</th>
            <th style="text-align: center;">Level</th>
            <th>Recipient</th>
            <th>Channel</th>
            <th>Sent</th>
            <th>Next Escalation</th>
        </tr>
        {% for esc in pending_escalations %}
        <tr>
            <td>{% if esc.journey %}{{ esc.journey.patient_mrn }}{% else %}-{% endif %}</td>
            <td>{{ esc.get_trigger_type_display }}</td>
            <td style="text-align: center;"><strong>{{ esc.escalation_level }}</strong></td>
            <td>{{ esc.recipient_role }}</td>
            <td>{{ esc.delivery_channel }}</td>
            <td>{{ esc.sent_at|date:"Y-m-d H:i" }}</td>
            <td>{{ esc.next_escalation_at|date:"Y-m-d H:i"|default:"Final" }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

<!-- Recently Completed -->
{% if recent_completed %}
<div class="section">
    <h2>Recently Completed</h2>
    <table>
        <tr>
            <th>Patient</th>
            <th>Procedure</th>
            <th style="text-align: center;">Order</th>
            <th style="text-align: center;">Given</th>
            <th>Completed</th>
        </tr>
        {% for j in recent_completed %}
        <tr>
            <td><strong>{{ j.patient_mrn }}</strong></td>
            <td>{{ j.procedure_description|truncatechars:40|default:"-" }}</td>
            <td style="text-align: center;">
                {% if j.order_exists %}<span style="color: #27ae60;">Yes</span>{% else %}<span style="color: #e74c3c;">No</span>{% endif %}
            </td>
            <td style="text-align: center;">
                {% if j.administered %}<span style="color: #27ae60;">Yes</span>{% else %}<span style="color: #e74c3c;">No</span>{% endif %}
            </td>
            <td>{{ j.completed_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

<div class="section">
    <a href="{% url 'surgical_prophylaxis:dashboard' %}" class="btn btn-outline">Back to Dashboard</a>
</div>

{% endblock %}
