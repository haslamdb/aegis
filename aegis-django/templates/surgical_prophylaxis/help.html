{% extends "surgical_prophylaxis/base.html" %}

{% block content %}
<h2>Surgical Prophylaxis - Help &amp; Documentation</h2>

<div class="action-card">
    <h3>Overview</h3>
    <p>
        The Surgical Prophylaxis module monitors compliance with ASHP (American Society of Health-System
        Pharmacists) guidelines for perioperative antibiotic prophylaxis. It evaluates 7 bundle elements
        for each surgical case and provides both batch compliance analysis and real-time OR monitoring.
    </p>
    <p>
        The module operates in two modes:
    </p>
    <ul>
        <li><strong>Batch Evaluation</strong> &mdash; Polls FHIR for completed procedures, evaluates 7 ASHP
            bundle elements, and creates alerts for non-compliant cases.</li>
        <li><strong>Real-time Monitoring</strong> &mdash; Tracks patients through the surgical pathway via
            HL7 ADT messages, checking prophylaxis status at key trigger points and escalating alerts.</li>
    </ul>

    <h3>7 ASHP Bundle Elements</h3>
    <table style="box-shadow: none;">
        <tr>
            <th>#</th>
            <th>Element</th>
            <th>What It Checks</th>
        </tr>
        <tr>
            <td><strong>1</strong></td>
            <td>Indication</td>
            <td>Is prophylaxis appropriate for this procedure type and CPT code?</td>
        </tr>
        <tr>
            <td><strong>2</strong></td>
            <td>Agent Selection</td>
            <td>Is the correct antibiotic prescribed per ASHP/CCHMC guidelines? Accounts for
                beta-lactam allergy and MRSA colonization.</td>
        </tr>
        <tr>
            <td><strong>3</strong></td>
            <td>Pre-op Timing</td>
            <td>Was the antibiotic given within the appropriate window before incision?
                Standard: 60 min. Extended (vancomycin, ciprofloxacin): 120 min.</td>
        </tr>
        <tr>
            <td><strong>4</strong></td>
            <td>Dosing</td>
            <td>Was the dose weight-appropriate? Checks pediatric mg/kg dosing with maximum caps.</td>
        </tr>
        <tr>
            <td><strong>5</strong></td>
            <td>Intraoperative Redosing</td>
            <td>For prolonged surgeries, was the antibiotic redosed at the appropriate interval?
                (e.g., cefazolin every 4 hours)</td>
        </tr>
        <tr>
            <td><strong>6</strong></td>
            <td>Post-op Continuation</td>
            <td>When indicated (cardiac, implant procedures), was prophylaxis continued post-operatively?</td>
        </tr>
        <tr>
            <td><strong>7</strong></td>
            <td>Discontinuation</td>
            <td>Was prophylaxis stopped within 24 hours (48 hours for cardiac)? Prolonged prophylaxis
                increases resistance risk without benefit.</td>
        </tr>
    </table>

    <h3>Compliance Scoring</h3>
    <p>
        Each element is assessed as <span class="badge met">Met</span>,
        <span class="badge not-met">Not Met</span>,
        <span class="badge n-a">N/A</span>,
        <span class="badge pending">Pending</span>, or
        <span class="badge unable">Unable to Assess</span>.
    </p>
    <p>
        The bundle compliance score is calculated as: <code>(elements met) / (applicable elements) &times; 100%</code>.
        A case is <strong>bundle compliant</strong> when all applicable elements are met (100%).
    </p>

    <h3>Exclusion Criteria</h3>
    <p>Cases are excluded from evaluation when:</p>
    <ul>
        <li><strong>Emergency surgery</strong> &mdash; Emergency cases may not follow standard protocols</li>
        <li><strong>Already on therapeutic antibiotics</strong> &mdash; Patient receiving treatment-dose antibiotics</li>
        <li><strong>Documented active infection</strong> &mdash; Surgery for an infected site</li>
    </ul>

    <h3>Real-time Trigger Points</h3>
    <table style="box-shadow: none;">
        <tr>
            <th>Trigger</th>
            <th>Timing</th>
            <th>Initial Alert To</th>
            <th>Escalation</th>
        </tr>
        <tr>
            <td><strong>T-24h</strong></td>
            <td>24 hours before surgery</td>
            <td>Pharmacy (dashboard)</td>
            <td>60 min &rarr; no escalation</td>
        </tr>
        <tr>
            <td><strong>T-2h</strong></td>
            <td>2 hours before surgery</td>
            <td>Pre-op RN (dashboard)</td>
            <td>30 min &rarr; Anesthesia</td>
        </tr>
        <tr>
            <td><strong>T-60min</strong></td>
            <td>60 minutes before surgery</td>
            <td>Anesthesia (dashboard)</td>
            <td>15 min &rarr; Surgeon</td>
        </tr>
        <tr>
            <td><strong>T-0</strong></td>
            <td>OR entry / incision</td>
            <td>Anesthesia (dashboard)</td>
            <td>5 min &rarr; ASP team</td>
        </tr>
        <tr>
            <td><strong>Pre-op Arrival</strong></td>
            <td>Patient arrives in pre-op holding</td>
            <td colspan="2">Event-driven check via HL7 ADT</td>
        </tr>
        <tr>
            <td><strong>OR Entry</strong></td>
            <td>Patient enters OR suite</td>
            <td colspan="2">Most critical &mdash; CRITICAL severity if no prophylaxis</td>
        </tr>
    </table>

    <h3>Alert Severity</h3>
    <table style="box-shadow: none;">
        <tr>
            <th>Severity</th>
            <th>Condition</th>
        </tr>
        <tr>
            <td><span class="badge critical">Critical</span></td>
            <td>No prophylaxis at OR entry, or ordered but not administered at incision</td>
        </tr>
        <tr>
            <td><span class="badge high">High</span></td>
            <td>Wrong agent, incorrect dosing, or no order at T-60min/T-2h</td>
        </tr>
        <tr>
            <td><span class="badge medium">Medium</span></td>
            <td>Duration/redosing issues, or no order at T-24h</td>
        </tr>
    </table>

    <h3>Patient Location Tracking</h3>
    <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 14px;">
        <span class="badge unknown">Unknown</span>
        &rarr; <span class="badge inpatient">Inpatient</span>
        &rarr; <span class="badge pre_op">Pre-Op</span>
        &rarr; <span class="badge or_suite">OR Suite</span>
        &rarr; <span class="badge pacu">PACU</span>
        &rarr; <span class="badge discharged">Discharged</span>
    </div>
    <p style="margin-top: 10px;">
        Location is determined from HL7 ADT A02 (transfer) messages. The system uses regex pattern
        matching on location codes to identify surgical workflow areas.
    </p>

    <h3>Management Commands</h3>
    <table style="box-shadow: none;">
        <tr>
            <th>Command</th>
            <th>Description</th>
        </tr>
        <tr>
            <td><code>python manage.py monitor_prophylaxis --once</code></td>
            <td>Run batch evaluation once and exit</td>
        </tr>
        <tr>
            <td><code>python manage.py monitor_prophylaxis --continuous</code></td>
            <td>Run continuous batch monitoring</td>
        </tr>
        <tr>
            <td><code>python manage.py monitor_prophylaxis --stats</code></td>
            <td>Show current compliance statistics</td>
        </tr>
        <tr>
            <td><code>python manage.py run_realtime_prophylaxis</code></td>
            <td>Start HL7 MLLP listener + real-time monitoring daemon</td>
        </tr>
        <tr>
            <td><code>python manage.py create_demo_prophylaxis --clear</code></td>
            <td>Create 8 demo cases with CCHMC units</td>
        </tr>
    </table>

    <h3>API Endpoints</h3>
    <ul>
        <li><code>GET /surgical-prophylaxis/api/stats/</code> &mdash; Current compliance statistics</li>
        <li><code>POST /surgical-prophylaxis/api/&lt;uuid&gt;/acknowledge/</code> &mdash; Acknowledge alert</li>
        <li><code>POST /surgical-prophylaxis/api/&lt;uuid&gt;/resolve/</code> &mdash; Resolve alert</li>
        <li><code>POST /surgical-prophylaxis/api/&lt;uuid&gt;/add-note/</code> &mdash; Add note to alert</li>
        <li><code>GET /surgical-prophylaxis/api/export/</code> &mdash; Export evaluations as CSV</li>
    </ul>

    <h3>CCHMC Guidelines Reference</h3>
    <p>
        This module uses CCHMC-specific surgical prophylaxis guidelines stored in
        <code>apps/surgical_prophylaxis/data/cchmc_surgical_prophylaxis_guidelines.json</code>.
        The guidelines cover 47 procedure types across 7 surgical specialties with procedure-specific
        antibiotic recommendations, dosing, and duration limits.
    </p>

    <h3>Links</h3>
    <ul>
        <li><a href="{% url 'surgical_prophylaxis:dashboard' %}">Dashboard</a> &mdash; Compliance overview with alerts</li>
        <li><a href="{% url 'surgical_prophylaxis:compliance' %}">Compliance</a> &mdash; Historical trends and per-element analysis</li>
        <li><a href="{% url 'surgical_prophylaxis:realtime' %}">Realtime</a> &mdash; Active journeys and escalations</li>
    </ul>

    <h3>Support</h3>
    <p>For technical support or feature requests, contact the AEGIS development team.</p>
</div>

{% endblock %}
