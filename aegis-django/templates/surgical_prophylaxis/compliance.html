{% extends "surgical_prophylaxis/base.html" %}

{% block content %}
<h2>Compliance Report</h2>

<!-- Filters -->
<div class="filter-bar">
    <form method="get">
        <div class="filter-group">
            <label>Procedure Category:</label>
            <select name="category" onchange="this.form.submit()">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat.value }}" {% if current_category == cat.value %}selected{% endif %}>{{ cat.label }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<!-- Summary Stats -->
<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=total title="Total Evaluations" color="teal" %}
    {% include "_includes/stat_card.html" with value=compliance_rate|floatformat:1 title="Bundle Compliance" subtitle="%" color="green" %}
    {% include "_includes/stat_card.html" with value=compliant title="Compliant" color="green" %}
    {% include "_includes/stat_card.html" with value=excluded title="Excluded" color="gray" %}
</div>

<!-- Per-Element Compliance -->
{% if element_rates %}
<div class="section">
    <h2>Per-Element Compliance Rates</h2>
    <table class="data-table">
        <tr>
            <th>Element</th>
            <th>Compliance Rate</th>
            <th style="width: 50%;">Bar</th>
        </tr>
        {% for name, rate in element_rates.items %}
        <tr>
            <td><strong>{{ name }}</strong></td>
            <td style="text-align: center;">{{ rate|floatformat:1 }}%</td>
            <td>
                <div class="compliance-bar">
                    <div class="compliance-fill" style="width: {{ rate|floatformat:0 }}%; {% if rate < 70 %}background: #e74c3c;{% elif rate < 90 %}background: #f39c12;{% endif %}">
                        {{ rate|floatformat:0 }}%
                    </div>
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

<!-- By Category -->
{% if category_stats %}
<div class="section">
    <h2>Compliance by Procedure Category</h2>
    <table class="data-table">
        <tr>
            <th>Category</th>
            <th style="text-align: center;">Total</th>
            <th style="text-align: center;">Compliant</th>
            <th style="text-align: center;">Rate</th>
            <th style="width: 40%;">Bar</th>
        </tr>
        {% for cat_name, cat_data in category_stats.items %}
        <tr>
            <td><strong>{{ cat_name }}</strong></td>
            <td style="text-align: center;">{{ cat_data.total }}</td>
            <td style="text-align: center;">{{ cat_data.compliant }}</td>
            <td style="text-align: center;">{{ cat_data.rate|floatformat:1 }}%</td>
            <td>
                <div class="compliance-bar">
                    <div class="compliance-fill" style="width: {{ cat_data.rate|floatformat:0 }}%; {% if cat_data.rate < 70 %}background: #e74c3c;{% elif cat_data.rate < 90 %}background: #f39c12;{% endif %}">
                        {{ cat_data.rate|floatformat:0 }}%
                    </div>
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

<div class="section">
    <div class="action-group">
        <a href="{% url 'surgical_prophylaxis:api_export' %}" class="btn btn--primary">Export to CSV</a>
        <a href="{% url 'surgical_prophylaxis:dashboard' %}" class="btn btn--secondary">Back to Dashboard</a>
    </div>
</div>

{% endblock %}
