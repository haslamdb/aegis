{% extends "surgical_prophylaxis/base.html" %}

{% block content %}
<h2>Case: {{ case.procedure_description|truncatechars:60 }}</h2>

<div class="detail-layout">
    <div class="detail-layout__main">
        <!-- Case Info -->
        <div class="detail-section">
            <h3 class="detail-section__title">Case Information</h3>
            <table class="data-table">
                <tr><td style="width: 180px;"><strong>Case ID</strong></td><td>{{ case.case_id }}</td></tr>
                <tr><td><strong>Patient MRN</strong></td><td>{{ case.patient_mrn }}</td></tr>
                <tr><td><strong>Patient Name</strong></td><td>{{ case.patient_name|default:"-" }}</td></tr>
                <tr><td><strong>Procedure</strong></td><td>{{ case.procedure_description }}</td></tr>
                <tr><td><strong>Category</strong></td><td>{{ case.get_procedure_category_display }}</td></tr>
                <tr><td><strong>CPT Codes</strong></td><td>{{ case.cpt_codes|join:", "|default:"-" }}</td></tr>
                <tr><td><strong>Surgeon</strong></td><td>{{ case.surgeon_name|default:"-" }}</td></tr>
                <tr><td><strong>Location</strong></td><td>{{ case.location|default:"-" }}</td></tr>
                <tr><td><strong>Scheduled OR</strong></td><td>{{ case.scheduled_or_time|date:"Y-m-d H:i"|default:"-" }}</td></tr>
                <tr><td><strong>Incision</strong></td><td>{{ case.actual_incision_time|date:"Y-m-d H:i"|default:"-" }}</td></tr>
                <tr><td><strong>Surgery End</strong></td><td>{{ case.surgery_end_time|date:"Y-m-d H:i"|default:"-" }}</td></tr>
                <tr>
                    <td><strong>Duration</strong></td>
                    <td>{% if case.surgery_duration_hours %}{{ case.surgery_duration_hours|floatformat:1 }} hours{% else %}-{% endif %}</td>
                </tr>
            </table>
        </div>

        <!-- Patient Factors -->
        <div class="detail-section">
            <h3 class="detail-section__title">Patient Factors</h3>
            <table class="data-table">
                <tr><td style="width: 180px;"><strong>Weight</strong></td><td>{% if case.patient_weight_kg %}{{ case.patient_weight_kg|floatformat:1 }} kg{% else %}-{% endif %}</td></tr>
                <tr><td><strong>Age</strong></td><td>{% if case.patient_age_years %}{{ case.patient_age_years|floatformat:1 }} years{% else %}-{% endif %}</td></tr>
                <tr><td><strong>Beta-lactam Allergy</strong></td><td>{% if case.has_beta_lactam_allergy %}{% include "_includes/badge.html" with text="Yes" color="red" %}{% else %}No{% endif %}</td></tr>
                <tr><td><strong>MRSA Colonized</strong></td><td>{% if case.mrsa_colonized %}{% include "_includes/badge.html" with text="Yes" color="orange" %}{% else %}No{% endif %}</td></tr>
                <tr><td><strong>Emergency</strong></td><td>{% if case.is_emergency %}{% include "_includes/badge.html" with text="Yes" color="red" %}{% else %}No{% endif %}</td></tr>
                <tr><td><strong>On Therapeutic Abx</strong></td><td>{% if case.already_on_therapeutic_abx %}Yes{% else %}No{% endif %}</td></tr>
                <tr><td><strong>Documented Infection</strong></td><td>{% if case.documented_infection %}Yes{% else %}No{% endif %}</td></tr>
            </table>
        </div>

        <!-- 7-Element Evaluation -->
        {% if latest_eval %}
        <div class="detail-section">
            <h3 class="detail-section__title">
                Bundle Compliance
                {% if latest_eval.excluded %}
                {% include "_includes/badge.html" with text="Excluded" color="gray" %}
                {% elif latest_eval.bundle_compliant %}
                {% include "_includes/badge.html" with text="Compliant" color="green" %}
                {% else %}
                {% include "_includes/badge.html" with text="Non-compliant" color="red" %}
                {% endif %}
                â€” {{ latest_eval.compliance_score|floatformat:0 }}%
                ({{ latest_eval.elements_met }}/{{ latest_eval.elements_total }} elements met)
            </h3>

            {% if latest_eval.excluded %}
            <p><strong>Exclusion reason:</strong> {{ latest_eval.exclusion_reason }}</p>
            {% endif %}

            <div class="element-grid">
                {% for name, result in latest_eval.element_results_list %}
                <div class="element-card {{ result.status|default:'pending' }}">
                    <div class="element-name">{{ name }}</div>
                    {% if result.status == 'met' %}
                    {% include "_includes/badge.html" with text="Met" color="green" %}
                    {% elif result.status == 'not_met' %}
                    {% include "_includes/badge.html" with text="Not Met" color="red" %}
                    {% elif result.status == 'n/a' %}
                    {% include "_includes/badge.html" with text="N/A" color="gray" %}
                    {% elif result.status == 'unable' %}
                    {% include "_includes/badge.html" with text="Unable" color="gray" %}
                    {% else %}
                    {% include "_includes/badge.html" with text="Pending" color="yellow" %}
                    {% endif %}
                    <div class="element-detail">{{ result.details|default:"" }}</div>
                    {% if result.recommendation %}
                    <div class="element-detail" style="color: #e67e22; margin-top: 4px;">{{ result.recommendation }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            {% if latest_eval.recommendations %}
            <h4>Recommendations</h4>
            <ul>
                {% for rec in latest_eval.recommendations %}
                <li>{{ rec }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if latest_eval.flags %}
            <h4>Flags</h4>
            <ul>
                {% for flag in latest_eval.flags %}
                <li style="color: #e67e22;">{{ flag }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endif %}

        <!-- Medications -->
        <div class="detail-section">
            <h3 class="detail-section__title">Medications</h3>
            {% if medications %}
            <table class="data-table">
                <tr>
                    <th>Type</th>
                    <th>Medication</th>
                    <th>Dose</th>
                    <th>Route</th>
                    <th>Time</th>
                </tr>
                {% for med in medications %}
                <tr>
                    <td>
                        {% if med.medication_type == 'order' %}
                        {% include "_includes/badge.html" with text="Order" color="blue" %}
                        {% else %}
                        {% include "_includes/badge.html" with text="Admin" color="green" %}
                        {% endif %}
                    </td>
                    <td>{{ med.medication_name }}</td>
                    <td>{{ med.dose_mg|floatformat:0 }} mg</td>
                    <td>{{ med.route }}</td>
                    <td>{{ med.event_time|date:"Y-m-d H:i" }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-muted">No medications recorded for this case.</p>
            {% endif %}
        </div>
    </div>

    <div class="detail-layout__sidebar">
        <!-- Alert Status -->
        {% if alerts %}
        <div class="detail-section">
            <h3 class="detail-section__title">Alerts</h3>
            {% for alert in alerts %}
            <div style="border-left: 4px solid {% if alert.severity == 'critical' %}var(--color-danger){% elif alert.severity == 'high' %}#e67e22{% elif alert.severity == 'medium' %}var(--color-warning){% else %}var(--color-info){% endif %}; padding: 8px 12px; margin: 5px 0;">
                {% include "_includes/badge.html" with text=alert.get_severity_display color=alert.severity %}
                {% include "_includes/badge.html" with text=alert.get_status_display color="gray" %}
                <p style="font-size: 13px; margin: 5px 0;">{{ alert.summary|truncatechars:100 }}</p>
                <small class="text-muted">{{ alert.created_at|date:"Y-m-d H:i" }}</small>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Audit Log -->
        {% if alerts %}
        <div class="detail-section">
            <h3 class="detail-section__title">Audit Log</h3>
            <div class="sp-timeline">
                {% for alert in alerts %}
                {% for audit in alert.audit_log.all %}
                <div class="sp-timeline-item">
                    <div class="sp-timeline-time">{{ audit.created_at|date:"Y-m-d H:i" }}</div>
                    <div class="sp-timeline-text">
                        <strong>{{ audit.action }}</strong>
                        {% if audit.performed_by %} by {{ audit.performed_by }}{% endif %}
                    </div>
                    {% if audit.details %}
                    <div class="element-detail">{{ audit.details|truncatechars:100 }}</div>
                    {% endif %}
                </div>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="detail-section">
            <h3 class="detail-section__title">Actions</h3>
            <a href="{% url 'surgical_prophylaxis:dashboard' %}" class="btn btn--secondary btn--sm" style="display: block; margin-bottom: 8px; text-align: center;">Back to Dashboard</a>
            <a href="{% url 'surgical_prophylaxis:compliance' %}" class="btn btn--secondary btn--sm" style="display: block; text-align: center;">Compliance Report</a>
        </div>
    </div>
</div>

{% endblock %}
