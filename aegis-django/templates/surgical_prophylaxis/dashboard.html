{% extends "surgical_prophylaxis/base.html" %}

{% block content %}
<h2>ASHP Bundle Compliance Dashboard</h2>

<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=stats.total_cases|default:"0" title="Total Cases (30d)" color="teal" %}
    {% include "_includes/stat_card.html" with value=stats.compliance_rate|default:"0"|floatformat:1 title="Bundle Compliance" subtitle="%" color="green" %}
    {% include "_includes/stat_card.html" with value=stats.pending_alerts|default:"0" title="Pending Alerts" color="red" %}
    {% include "_includes/stat_card.html" with value=stats.avg_score|default:"0"|floatformat:0 title="Avg Score" subtitle="%" color="blue" %}
</div>

<!-- Per-Element Rates -->
{% if stats.element_rates %}
<div class="section">
    <h2>Bundle Element Compliance</h2>
    <div class="element-grid">
        {% for name, rate in stats.element_rates.items %}
        <div class="element-card {% if rate >= 90 %}met{% elif rate >= 70 %}pending{% else %}not-met{% endif %}">
            <div class="element-name">{{ name }}</div>
            <div class="compliance-bar">
                <div class="compliance-fill" style="width: {{ rate|floatformat:0 }}%; {% if rate < 70 %}background: #e74c3c;{% elif rate < 90 %}background: #f39c12;{% endif %}">
                    {{ rate|floatformat:0 }}%
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Pending Alerts -->
{% if pending_alerts %}
<div class="section">
    <h2>Pending Alerts</h2>
    {% for alert in pending_alerts %}
    <div class="detail-section" style="border-left: 5px solid {% if alert.severity == 'critical' %}var(--color-danger){% elif alert.severity == 'high' %}#e67e22{% elif alert.severity == 'medium' %}var(--color-warning){% else %}var(--color-info){% endif %}; margin-bottom: 10px;">
        <strong>{{ alert.title }}</strong>
        {% include "_includes/badge.html" with text=alert.get_severity_display color=alert.severity %}
        <p>{{ alert.summary }}</p>
        <small class="text-muted">{{ alert.created_at|date:"Y-m-d H:i" }}</small>
        {% if alert.details.case_id %}
        | <a href="{% url 'surgical_prophylaxis:case_detail' alert.source_id %}">View Case</a>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Recent Evaluations -->
<div class="section">
    <h2>Recent Evaluations</h2>
    {% if recent_evaluations %}
    <table class="data-table">
        <tr>
            <th>Patient</th>
            <th>Procedure</th>
            <th>Category</th>
            <th style="text-align: center;">Score</th>
            <th style="text-align: center;">Status</th>
            <th>Time</th>
            <th style="text-align: center;">Actions</th>
        </tr>
        {% for eval in recent_evaluations %}
        <tr>
            <td><strong>{{ eval.case.patient_mrn }}</strong></td>
            <td>{{ eval.case.procedure_description|truncatechars:40 }}</td>
            <td>{{ eval.case.get_procedure_category_display }}</td>
            <td style="text-align: center;">
                <strong>{{ eval.compliance_score|floatformat:0 }}%</strong>
            </td>
            <td style="text-align: center;">
                {% if eval.excluded %}
                {% include "_includes/badge.html" with text="Excluded" color="gray" %}
                {% elif eval.bundle_compliant %}
                {% include "_includes/badge.html" with text="Compliant" color="green" %}
                {% else %}
                {% include "_includes/badge.html" with text="Non-compliant" color="red" %}
                {% endif %}
            </td>
            <td>{{ eval.evaluation_time|date:"Y-m-d H:i" }}</td>
            <td style="text-align: center;">
                <a href="{% url 'surgical_prophylaxis:case_detail' eval.case.id %}" class="btn btn--primary btn--sm">View</a>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="detail-section" style="text-align: center; padding: 40px;">
        <h3>No Evaluations Yet</h3>
        <p class="text-muted">Run <code>python manage.py create_demo_prophylaxis</code> to create demo data.</p>
    </div>
    {% endif %}
</div>

<div class="section">
    <div class="action-group">
        <a href="{% url 'surgical_prophylaxis:compliance' %}" class="btn btn--secondary">View Compliance Trends</a>
        <a href="{% url 'surgical_prophylaxis:realtime' %}" class="btn btn--secondary">Real-time Monitoring</a>
        <a href="{% url 'surgical_prophylaxis:api_export' %}" class="btn btn--secondary">Export CSV</a>
    </div>
</div>

{% endblock %}
