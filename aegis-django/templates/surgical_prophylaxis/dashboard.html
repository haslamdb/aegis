{% extends "surgical_prophylaxis/base.html" %}

{% block content %}
<h2>ASHP Bundle Compliance Dashboard</h2>

<div class="stats-row">
    <div class="stat-box cases-stat">
        <div class="stat-value">{{ stats.total_cases|default:"0" }}</div>
        <div class="stat-label">Total Cases (30d)</div>
    </div>
    <div class="stat-box compliance-stat">
        <div class="stat-value">{{ stats.compliance_rate|default:"0"|floatformat:1 }}%</div>
        <div class="stat-label">Bundle Compliance</div>
    </div>
    <div class="stat-box alerts-stat">
        <div class="stat-value">{{ stats.pending_alerts|default:"0" }}</div>
        <div class="stat-label">Pending Alerts</div>
    </div>
    <div class="stat-box score-stat">
        <div class="stat-value">{{ stats.avg_score|default:"0"|floatformat:0 }}%</div>
        <div class="stat-label">Avg Score</div>
    </div>
</div>

<!-- Per-Element Rates -->
{% if stats.element_rates %}
<div class="section">
    <h2>Bundle Element Compliance</h2>
    <div class="element-grid">
        {% for name, rate in stats.element_rates.items %}
        <div class="element-card {% if rate >= 90 %}met{% elif rate >= 70 %}pending{% else %}not-met{% endif %}">
            <div class="element-name">{{ name }}</div>
            <div class="compliance-bar">
                <div class="compliance-fill" style="width: {{ rate|floatformat:0 }}%; {% if rate < 70 %}background: #e74c3c;{% elif rate < 90 %}background: #f39c12;{% endif %}">
                    {{ rate|floatformat:0 }}%
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Pending Alerts -->
{% if pending_alerts %}
<div class="section">
    <h2>Pending Alerts</h2>
    {% for alert in pending_alerts %}
    <div class="alert-box {{ alert.severity }}">
        <strong>{{ alert.title }}</strong>
        <span class="badge {{ alert.severity }}">{{ alert.get_severity_display }}</span>
        <p>{{ alert.summary }}</p>
        <small class="text-muted">{{ alert.created_at|date:"Y-m-d H:i" }}</small>
        {% if alert.details.case_id %}
        | <a href="{% url 'surgical_prophylaxis:case_detail' alert.source_id %}">View Case</a>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Recent Evaluations -->
<div class="section">
    <h2>Recent Evaluations</h2>
    {% if recent_evaluations %}
    <table>
        <tr>
            <th>Patient</th>
            <th>Procedure</th>
            <th>Category</th>
            <th style="text-align: center;">Score</th>
            <th style="text-align: center;">Status</th>
            <th>Time</th>
            <th style="text-align: center;">Actions</th>
        </tr>
        {% for eval in recent_evaluations %}
        <tr>
            <td><strong>{{ eval.case.patient_mrn }}</strong></td>
            <td>{{ eval.case.procedure_description|truncatechars:40 }}</td>
            <td>{{ eval.case.get_procedure_category_display }}</td>
            <td style="text-align: center;">
                <strong>{{ eval.compliance_score|floatformat:0 }}%</strong>
            </td>
            <td style="text-align: center;">
                {% if eval.excluded %}
                <span class="badge excluded">Excluded</span>
                {% elif eval.bundle_compliant %}
                <span class="badge compliant">Compliant</span>
                {% else %}
                <span class="badge non-compliant">Non-compliant</span>
                {% endif %}
            </td>
            <td>{{ eval.evaluation_time|date:"Y-m-d H:i" }}</td>
            <td style="text-align: center;">
                <a href="{% url 'surgical_prophylaxis:case_detail' eval.case.id %}" class="btn btn-primary btn-sm">View</a>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="action-card" style="text-align: center; padding: 40px;">
        <h3>No Evaluations Yet</h3>
        <p class="text-muted">Run <code>python manage.py create_demo_prophylaxis</code> to create demo data.</p>
    </div>
    {% endif %}
</div>

<div class="section">
    <a href="{% url 'surgical_prophylaxis:compliance' %}" class="btn btn-outline">View Compliance Trends</a>
    <a href="{% url 'surgical_prophylaxis:realtime' %}" class="btn btn-outline">Real-time Monitoring</a>
    <a href="{% url 'surgical_prophylaxis:api_export' %}" class="btn btn-outline">Export CSV</a>
</div>

{% endblock %}
