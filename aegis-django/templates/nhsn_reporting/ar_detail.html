{% extends "nhsn_reporting/base.html" %}

{% block title %}Antimicrobial Resistance - NHSN Reporting{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Antimicrobial Resistance (AR)</h1>
    <p>Quarterly isolate counts by organism with resistance phenotype classification (first-isolate deduplication applied)</p>
</div>

<div class="detail-section">
    <div class="detail-section__title" style="display: flex; align-items: center; justify-content: space-between;">
        AR Summary
        <a href="{% url 'nhsn_reporting:api_ar_export' %}?quarter={{ quarter_filter }}&location={{ location_filter }}" class="btn btn--secondary btn--sm">Export CSV</a>
    </div>
    <div class="filter-bar">
        <form method="get" class="filter-form">
            <div class="filter-group">
                <label>Quarter:</label>
                <select name="quarter" onchange="this.form.submit()">
                    <option value="">All Quarters</option>
                    {% for q in quarters %}
                    <option value="{{ q.value }}" {% if quarter_filter == q.value %}selected{% endif %}>{{ q.label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label>Location:</label>
                <select name="location" onchange="this.form.submit()">
                    <option value="">All Locations</option>
                    {% for loc in locations %}
                    <option value="{{ loc }}" {% if location_filter == loc %}selected{% endif %}>{{ loc }}</option>
                    {% endfor %}
                </select>
            </div>

            {% if quarter_filter or location_filter %}
            <div class="filter-group">
                <a href="{% url 'nhsn_reporting:ar_detail' %}" class="btn btn--secondary btn--sm">Clear</a>
            </div>
            {% endif %}
        </form>
    </div>

    {% if summaries %}
    <!-- Phenotype Summary -->
    <div class="section-header">Resistance Phenotypes</div>
    <div class="stat-cards" style="margin-bottom: 1.5rem;">
        {% include "_includes/stat_card.html" with value=summaries.mrsa_count|default:0 title="MRSA Isolates" color="green" %}
        {% include "_includes/stat_card.html" with value=summaries.vre_count|default:0 title="VRE Isolates" color="teal" %}
        {% include "_includes/stat_card.html" with value=summaries.esbl_count|default:0 title="ESBL Isolates" color="blue" %}
        {% include "_includes/stat_card.html" with value=summaries.cre_count|default:0 title="CRE Isolates" color="red" %}
    </div>

    <!-- Organism Detail Table -->
    <div class="section-header">Isolates by Organism</div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Organism</th>
                <th>Total Isolates</th>
                <th>First Isolates</th>
                <th>Resistant</th>
                <th>%R</th>
                <th>Phenotype</th>
                <th>Location</th>
                <th>Quarter</th>
            </tr>
        </thead>
        <tbody>
            {% for s in summaries.organisms %}
            <tr>
                <td>
                    <strong><em>{{ s.organism_name }}</em></strong><br>
                    <small style="color: #888;">{{ s.nhsn_code|default:"" }}</small>
                </td>
                <td>{{ s.total_isolates }}</td>
                <td style="font-weight: 600;">{{ s.first_isolates }}</td>
                <td style="color: #dc3545; font-weight: 600;">{{ s.resistant_count }}</td>
                <td>
                    {% if s.first_isolates > 0 %}
                        {% if s.pct_resistant > 30 %}
                            {% include "_includes/badge.html" with text=s.pct_resistant|stringformat:"d"|add:"%" color="red" %}
                        {% elif s.pct_resistant > 15 %}
                            {% include "_includes/badge.html" with text=s.pct_resistant|stringformat:"d"|add:"%" color="yellow" %}
                        {% else %}
                            {% include "_includes/badge.html" with text=s.pct_resistant|stringformat:"d"|add:"%" color="green" %}
                        {% endif %}
                    {% else %}
                        {% include "_includes/badge.html" with text="N/A" color="gray" %}
                    {% endif %}
                </td>
                <td>
                    {% for pheno in s.phenotypes %}
                        {% include "_includes/badge.html" with text=pheno color=pheno|lower %}
                    {% empty %}
                    <span style="color: #888;">--</span>
                    {% endfor %}
                </td>
                <td>{{ s.location }}</td>
                <td style="font-size: 0.85rem;">{{ s.quarter_label }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No AR data available</h3>
        <p>No antimicrobial resistance data for the selected filters. Ensure Clarity batch jobs are running and culture results are being processed.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
