{% extends "hai_detection/base.html" %}

{% block content %}
<h2>HAI Reports &amp; Analytics</h2>

<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label>Time Period:</label>
            <select name="period" onchange="this.form.submit()">
                <option value="7" {% if period == '7' %}selected{% endif %}>7 days</option>
                <option value="30" {% if period == '30' %}selected{% endif %}>30 days</option>
                <option value="90" {% if period == '90' %}selected{% endif %}>90 days</option>
                <option value="365" {% if period == '365' %}selected{% endif %}>1 year</option>
            </select>
        </div>
    </form>
</div>

{# Summary Stats #}
<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=stats.total_confirmed title="Confirmed HAI" color="green" %}
    {% include "_includes/stat_card.html" with value=stats.total_rejected title="Not HAI" color="red" %}
    {% include "_includes/stat_card.html" with value=stats.total_reviewed title="Total Reviewed" color="gray" %}
    {% include "_includes/stat_card.html" with value=stats.confirmation_rate|stringformat:"d"|add:"%" title="HAI Rate" color="blue" %}
</div>

{# HAI Rates by Type #}
<h3>HAI by Type</h3>
{% if stats.by_type %}
<table class="data-table">
    <tr>
        <th>HAI Type</th>
        <th>Confirmed</th>
        <th>Total Reviewed</th>
        <th>Rate</th>
    </tr>
    {% for item in stats.by_type %}
    <tr>
        <td>{% include "_includes/badge.html" with text=item.hai_type|upper color=item.hai_type|lower %}</td>
        <td>{{ item.confirmed }}</td>
        <td>{{ item.total }}</td>
        <td>
            {% if item.total > 0 %}
                {% widthratio item.confirmed item.total 100 %}%
            {% else %}
                0%
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No HAI data available for this period.</p>
{% endif %}

{# LLM Accuracy Metrics #}
<h3>LLM Classification Quality</h3>
{% if override_stats and override_stats.completed_reviews > 0 %}
<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=override_stats.completed_reviews title="Completed Reviews" color="green" %}
    {% include "_includes/stat_card.html" with value=override_stats.acceptance_rate_pct|default:"--"|add:"%" title="LLM Acceptance Rate" color="blue" %}
    {% include "_includes/stat_card.html" with value=override_stats.total_overrides title="IP Overrides" color="orange" %}
    {% include "_includes/stat_card.html" with value=override_stats.override_rate_pct|default:"--"|add:"%" title="Override Rate" color="red" %}
</div>

{# Override Rate by LLM Decision #}
{% if override_stats.by_llm_decision %}
<h4>Override Rate by LLM Decision</h4>
<table class="data-table">
    <tr>
        <th>LLM Said</th>
        <th>Total</th>
        <th>Overrides</th>
        <th>Rate</th>
    </tr>
    {% for decision, data in override_stats.by_llm_decision.items %}
    <tr>
        <td>
            {% if decision == 'hai_confirmed' %}
                {% include "_includes/badge.html" with text="HAI" color="confirmed" %}
            {% elif decision == 'not_hai' %}
                {% include "_includes/badge.html" with text="Not HAI" color="pending" %}
            {% elif decision == 'pending_review' %}
                {% include "_includes/badge.html" with text="Uncertain" color="warning" %}
            {% else %}
                {% include "_includes/badge.html" with text=decision color="default" %}
            {% endif %}
        </td>
        <td>{{ data.total }}</td>
        <td>{{ data.overrides }}</td>
        <td style="{% if data.override_rate_pct <= 20 %}color: #27ae60;{% elif data.override_rate_pct <= 40 %}color: #f39c12;{% else %}color: #e74c3c;{% endif %} font-weight: bold;">
            {{ data.override_rate_pct }}%
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% else %}
<p>No reviewed cases yet. LLM quality metrics will appear after IP reviews are submitted.</p>
{% endif %}

{# Recent Overrides #}
{% if recent_overrides %}
<h3>Recent IP Overrides</h3>
<table class="data-table">
    <tr>
        <th>Date</th>
        <th>Patient</th>
        <th>HAI Type</th>
        <th>Organism</th>
        <th>LLM Decision</th>
        <th>IP Decision</th>
        <th>Override Reason</th>
    </tr>
    {% for override in recent_overrides %}
    <tr>
        <td>{{ override.reviewed_at|date:"Y-m-d" }}</td>
        <td>{{ override.patient_mrn }}</td>
        <td>
            {% include "_includes/badge.html" with text=override.hai_type|upper color=override.hai_type|lower %}
        </td>
        <td>{{ override.organism|default:"Unknown" }}</td>
        <td>
            {% if override.llm_decision == 'hai_confirmed' %}
                {% include "_includes/badge.html" with text="HAI" color="confirmed" %}
            {% elif override.llm_decision == 'not_hai' %}
                {% include "_includes/badge.html" with text="Not HAI" color="pending" %}
            {% else %}
                {% include "_includes/badge.html" with text=override.llm_decision color="default" %}
            {% endif %}
        </td>
        <td>
            {% if override.reviewer_decision == 'confirmed' %}
                {% include "_includes/badge.html" with text="Confirmed" color="confirmed" %}
            {% elif override.reviewer_decision == 'rejected' %}
                {% include "_includes/badge.html" with text="Rejected" color="rejected" %}
            {% else %}
                {% include "_includes/badge.html" with text=override.reviewer_decision color="default" %}
            {% endif %}
        </td>
        <td>{{ override.override_reason_category|default:"-" }}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% endblock %}
