{% extends "asp_alerts/base.html" %}

{% block content %}
<h2>Alert History (Last {{ days }} days)</h2>

<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label>Type:</label>
            <select name="type" onchange="this.form.submit()">
                <option value="">All</option>
                {% for type_value, type_label in alert_types %}
                <option value="{{ type_value }}" {% if current_filters.type == type_value %}selected{% endif %}>
                    {{ type_label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Resolution:</label>
            <select name="resolution" onchange="this.form.submit()">
                <option value="">All Reasons</option>
                {% for reason_value, reason_label in resolution_reasons %}
                <option value="{{ reason_value }}" {% if current_filters.resolution == reason_value %}selected{% endif %}>
                    {{ reason_label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>MRN:</label>
            <input type="text" name="mrn" value="{{ current_filters.mrn|default:'' }}" placeholder="Search by MRN">
        </div>

        <div class="filter-group">
            <label>Days:</label>
            <select name="days" onchange="this.form.submit()">
                <option value="7" {% if days == 7 %}selected{% endif %}>7 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>30 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>90 days</option>
                <option value="365" {% if days == 365 %}selected{% endif %}>1 year</option>
            </select>
        </div>

        <button type="submit" class="btn btn--primary">Apply</button>
    </form>
</div>

<p><strong>{{ alerts|length }}</strong> resolved alert{{ alerts|length|pluralize }}</p>

<table class="data-table">
    <thead>
    <tr>
        <th>Resolved</th>
        <th>Type</th>
        <th>Severity</th>
        <th>Patient</th>
        <th>Message</th>
        <th>Resolution Reason</th>
        <th>Resolved By</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for alert in alerts %}
    <tr>
        <td>{{ alert.resolved_at|date:"Y-m-d H:i" }}</td>
        <td><span class="badge">{{ alert.get_alert_type_display }}</span></td>
        <td>{% include "_includes/badge.html" with text=alert.get_severity_display color=alert.severity|lower %}</td>
        <td>
            {% if alert.patient_name %}
                {{ alert.patient_name }}<br>
                <small class="text-muted">MRN: {{ alert.patient_mrn }}</small>
            {% else %}
                Unknown
            {% endif %}
        </td>
        <td>{{ alert.title }}</td>
        <td>{{ alert.get_resolution_reason_display|default:"N/A" }}</td>
        <td>{{ alert.resolved_by.username|default:"System" }}</td>
        <td>
            <a href="{% url 'asp_alerts:detail' alert.id %}" class="btn btn--primary btn--sm">
                View
            </a>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="8" class="text-center">No resolved alerts found.</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}
