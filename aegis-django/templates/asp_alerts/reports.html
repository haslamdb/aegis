{% extends "asp_alerts/base.html" %}

{% block content %}
<h2>Alert Analytics & Reports (Last {{ days }} days)</h2>

<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label>Time Period:</label>
            <select name="days" onchange="this.form.submit()">
                <option value="7" {% if days == 7 %}selected{% endif %}>7 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>30 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>90 days</option>
                <option value="365" {% if days == 365 %}selected{% endif %}>1 year</option>
            </select>
        </div>
    </form>
</div>

<div class="stat-cards">
    {% include "_includes/stat_card.html" with value=total_alerts title="Total Alerts" color="teal" %}
    {% include "_includes/stat_card.html" with value=active_count title="Active Alerts" color="yellow" %}
    {% include "_includes/stat_card.html" with value=resolved_count title="Resolved Alerts" color="green" %}
</div>

<h3>Alerts by Severity</h3>
<table class="data-table">
    <thead>
    <tr>
        <th>Severity</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    </thead>
    <tbody>
    {% for item in by_severity %}
    <tr>
        <td>{% include "_includes/badge.html" with text=item.severity|upper color=item.severity|lower %}</td>
        <td>{{ item.count }}</td>
        <td>{% if total_alerts > 0 %}{% widthratio item.count total_alerts 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="3" class="text-center">No data available</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<h3>Alerts by Status</h3>
<table class="data-table">
    <thead>
    <tr>
        <th>Status</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    </thead>
    <tbody>
    {% for item in by_status %}
    <tr>
        <td>{% include "_includes/badge.html" with text=item.status|upper color=item.status|lower %}</td>
        <td>{{ item.count }}</td>
        <td>{% if total_alerts > 0 %}{% widthratio item.count total_alerts 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="3" class="text-center">No data available</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<h3>Alerts by Type</h3>
<table class="data-table">
    <thead>
    <tr>
        <th>Alert Type</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    </thead>
    <tbody>
    {% for item in by_type %}
    <tr>
        <td>{{ item.alert_type|upper }}</td>
        <td>{{ item.count }}</td>
        <td>{% if total_alerts > 0 %}{% widthratio item.count total_alerts 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="3" class="text-center">No data available</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% if by_resolution %}
<h3>Resolution Reasons ({{ resolved_count }} resolved alerts)</h3>
<table class="data-table">
    <thead>
    <tr>
        <th>Resolution Reason</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    </thead>
    <tbody>
    {% for item in by_resolution %}
    <tr>
        <td>{{ item.resolution_reason|upper|default:"Not Specified" }}</td>
        <td>{{ item.count }}</td>
        <td>{% if resolved_count > 0 %}{% widthratio item.count resolved_count 100 %}%{% else %}0%{% endif %}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% endif %}

{% endblock %}
