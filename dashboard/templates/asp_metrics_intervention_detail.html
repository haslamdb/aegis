{% extends "base.html" %}

{% block title %}Session: {{ session.topic or session.session_type }} - ASP/IP Metrics - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Intervention Session</h1>
    <div class="header-actions">
        <a href="{{ url_for('asp_metrics.interventions') }}" class="btn btn-secondary">Back to Interventions</a>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Session Details -->
    <div class="dashboard-card">
        <h3>Session Details</h3>
        <dl class="detail-list">
            <div class="detail-row">
                <dt>Session Type</dt>
                <dd>
                    <span class="type-badge type-{{ session.session_type }}">
                        {{ session.session_type | replace('_', ' ') | title }}
                    </span>
                </dd>
            </div>
            <div class="detail-row">
                <dt>Session Date</dt>
                <dd>{{ session.session_date }}</dd>
            </div>
            <div class="detail-row">
                <dt>Conducted By</dt>
                <dd>{{ session.conducted_by or '--' }}</dd>
            </div>
            <div class="detail-row">
                <dt>Topic</dt>
                <dd>{{ session.topic or '--' }}</dd>
            </div>
        </dl>
    </div>

    <!-- Target Info -->
    <div class="dashboard-card">
        <h3>Target</h3>
        <dl class="detail-list">
            <div class="detail-row">
                <dt>Target Type</dt>
                <dd>{{ session.target_type | replace('_', ' ') | title }}</dd>
            </div>
            <div class="detail-row">
                <dt>Target ID</dt>
                <dd>{{ session.target_id or '--' }}</dd>
            </div>
            <div class="detail-row">
                <dt>Target Name</dt>
                <dd>{{ session.target_name or '--' }}</dd>
            </div>
        </dl>
    </div>
</div>

<!-- Attendees -->
<div class="dashboard-card">
    <h3>Attendees</h3>
    {% if session.attendees %}
    <div class="attendees-list">
        {% for attendee in session.attendees %}
        <span class="attendee-badge">{{ attendee }}</span>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No attendees recorded</p>
    {% endif %}
</div>

<!-- Notes -->
<div class="dashboard-card">
    <h3>Notes</h3>
    {% if session.notes %}
    <div class="notes-content">
        {{ session.notes }}
    </div>
    {% else %}
    <p class="empty-state">No notes recorded</p>
    {% endif %}
</div>

<!-- Related Alerts -->
{% if session.related_alerts %}
<div class="dashboard-card">
    <h3>Related Alerts</h3>
    <div class="related-list">
        {% for alert_id in session.related_alerts %}
        <span class="related-badge">{{ alert_id }}</span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Outcomes -->
<div class="dashboard-card">
    <h3>Intervention Outcomes</h3>
    {% if outcomes %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Target</th>
                <th>Pre Value</th>
                <th>Post Value</th>
                <th>Change</th>
                <th>Improved?</th>
                <th>Sustained?</th>
            </tr>
        </thead>
        <tbody>
            {% for outcome in outcomes %}
            <tr>
                <td>Target #{{ outcome.target_id }}</td>
                <td>{{ outcome.pre_value | round(1) if outcome.pre_value is not none else '--' }}</td>
                <td>{{ outcome.post_value | round(1) if outcome.post_value is not none else '--' }}</td>
                <td>
                    {% if outcome.percent_change is not none %}
                        {{ ('+' if outcome.percent_change >= 0 else '') }}{{ outcome.percent_change | round(1) }}%
                    {% else %}
                        --
                    {% endif %}
                </td>
                <td>
                    {% if outcome.is_improvement is not none %}
                        <span class="{{ 'text-success' if outcome.is_improvement else 'text-warning' }}">
                            {{ 'Yes' if outcome.is_improvement else 'No' }}
                        </span>
                    {% else %}
                        --
                    {% endif %}
                </td>
                <td>
                    {% if outcome.sustained_improvement is not none %}
                        <span class="{{ 'text-success' if outcome.sustained_improvement else 'text-warning' }}">
                            {{ 'Yes' if outcome.sustained_improvement else 'No' }}
                        </span>
                    {% else %}
                        --
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No outcomes linked to this session</p>
    {% endif %}
</div>

<style>
.detail-list {
    margin: 0;
}

.detail-row {
    display: flex;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-row dt {
    width: 120px;
    flex-shrink: 0;
    font-weight: 500;
    color: #6b7280;
}

.detail-row dd {
    margin: 0;
}

.type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.type-unit_rounding {
    background: #dbeafe;
    color: #1e40af;
}

.type-service_education {
    background: #dcfce7;
    color: #166534;
}

.type-individual_feedback {
    background: #fef3c7;
    color: #92400e;
}

.type-committee {
    background: #f3e8ff;
    color: #6b21a8;
}

.attendees-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.attendee-badge {
    background: #f3f4f6;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
}

.notes-content {
    white-space: pre-wrap;
    background: #f9fafb;
    padding: 1rem;
    border-radius: 4px;
}

.related-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.related-badge {
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: monospace;
}

.text-success {
    color: #16a34a;
    font-weight: bold;
}

.text-warning {
    color: #d97706;
}

.empty-state {
    text-align: center;
    color: #6b7280;
    padding: 1.5rem;
}
</style>
{% endblock %}
