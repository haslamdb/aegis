{% extends "base.html" %}

{% block title %}Antibiotic Indications Help - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Antibiotic Indications - Help</h1>
    <a href="{{ url_for('abx_indications.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="help-content">
    <div class="help-card">
        <h2>Overview</h2>
        <p>The Antibiotic Indications module provides automated classification of antibiotic indication appropriateness
           using a two-layer approach:</p>
        <ol>
            <li><strong>LLM Note Extraction (Primary)</strong> - AI-powered extraction from clinical notes provides the most accurate, real-time classification</li>
            <li><strong>ICD-10 Classification (Fallback)</strong> - Based on Chua et al. methodology, used when notes are unavailable</li>
        </ol>
        <p>This module implements <strong>Layer 1</strong> of the three-layer appropriateness model, answering:
           "Is there ANY indication for antibiotics?"</p>
    </div>

    <div class="help-card">
        <h2>How It Works</h2>
        <div class="workflow-diagram">
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <strong>New Antibiotic Order</strong>
                    <p>System detects new antibiotic orders from monitored medications list</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <strong>LLM Note Extraction (Primary)</strong>
                    <p>AI extracts indications from clinical notes (48h window) with provider attribution and supporting quotes</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <strong>ICD-10 Classification (Fallback)</strong>
                    <p>Patient's ICD-10 codes mapped using Chua classification - used when notes unavailable</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <strong>Final Classification</strong>
                    <p>LLM result takes precedence; ICD-10 used only as fallback</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <strong>ASP Review</strong>
                    <p>Orders classified as "N" (Never Appropriate) generate alerts for review</p>
                </div>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>Classification Categories</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Code</th>
                    <th>Meaning</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-success">Always</span></td>
                    <td>A</td>
                    <td>Antibiotic indicated - documented bacterial infection</td>
                    <td>No alert needed</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">Sometimes</span></td>
                    <td>S</td>
                    <td>May need antibiotics - clinical judgment required</td>
                    <td>No alert (clinical discretion)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">Never</span></td>
                    <td>N</td>
                    <td>No antibiotic indication - likely inappropriate</td>
                    <td><strong>Alert generated</strong></td>
                </tr>
                <tr>
                    <td><span class="badge badge-info">Prophylaxis</span></td>
                    <td>P</td>
                    <td>Surgical or medical prophylaxis indication</td>
                    <td>No alert needed</td>
                </tr>
                <tr>
                    <td><span class="badge badge-success">Febrile Neutropenia</span></td>
                    <td>FN</td>
                    <td>Neutropenia + fever - empiric therapy indicated</td>
                    <td>No alert needed</td>
                </tr>
                <tr>
                    <td><span class="badge badge-secondary">Unknown</span></td>
                    <td>U</td>
                    <td>Unable to determine - no ICD-10 or notes available</td>
                    <td>May need manual review</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>LLM Note Extraction (Primary Classification)</h2>
        <p>The system uses a local LLM (llama3.2 via Ollama) to extract indications from clinical notes. This is the <strong>primary classification method</strong>:</p>
        <ul>
            <li><strong>Note Window:</strong> 48 hours before/after the antibiotic order</li>
            <li><strong>Note Filtering:</strong> Pre-filters notes by antibiotic name and infection keywords</li>
            <li><strong>Priority Notes:</strong> ID consults, discharge summaries always included</li>
            <li><strong>Evidence Sources:</strong> Tracks provider name, note type, date for each finding</li>
            <li><strong>Confidence:</strong> HIGH, MEDIUM, or LOW based on evidence quality</li>
        </ul>
        <h3>Why LLM is the Primary Source</h3>
        <ul>
            <li>ICD-10 codes may be stale (from previous encounters)</li>
            <li>Notes reflect real-time clinical reasoning</li>
            <li>Notes capture nuance that codes cannot (e.g., "viral illness, antibiotics not indicated")</li>
            <li>Provider attribution allows verification of clinical decisions</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>Reviewing Classifications</h2>
        <p>Click any row in the dashboard to open the detail page where you can:</p>
        <ol>
            <li>View LLM extraction with evidence sources (provider, note type, date)</li>
            <li>View supporting quotes from clinical notes</li>
            <li>View ICD-10 codes (fallback classification)</li>
            <li>Compare LLM vs ICD-10 classifications</li>
            <li><strong>Confirm</strong> or <strong>Override</strong> the final classification</li>
            <li>Add notes explaining your decision</li>
        </ol>
        <p class="note"><strong>Note:</strong> Your review notes are stored and will be used for LLM fine-tuning to improve future classifications.</p>
    </div>

    <div class="help-card">
        <h2>Data Sources</h2>
        <h3>ICD-10 Classification (Chua)</h3>
        <ul>
            <li>94,249 ICD-10 codes mapped to appropriateness categories</li>
            <li>Based on: Chua KP, et al. "Appropriateness of outpatient antibiotic prescribing." BMJ 2019</li>
        </ul>
        <h3>Pediatric Inpatient Modifications</h3>
        <table class="help-table help-table-compact">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Original</th>
                    <th>Modified</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>R78.81</td>
                    <td>Bacteremia</td>
                    <td>N</td>
                    <td><strong>A</strong></td>
                    <td>Inpatient bacteremia always requires treatment</td>
                </tr>
                <tr>
                    <td>J69.0</td>
                    <td>Aspiration PNA</td>
                    <td>N</td>
                    <td><strong>S</strong></td>
                    <td>Often requires empiric coverage</td>
                </tr>
                <tr>
                    <td>K65.x</td>
                    <td>Peritonitis</td>
                    <td>S</td>
                    <td><strong>A</strong></td>
                    <td>Surgical emergency requiring antibiotics</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Febrile Neutropenia Detection</h2>
        <p>Febrile neutropenia is automatically detected when:</p>
        <ul>
            <li>ANY neutropenia code (D70.x) is present, AND</li>
            <li>Fever code (R50.x) is present OR temperature &ge; 38.0C</li>
        </ul>
        <p>Result: Category <strong>FN</strong> with recommendation for empiric antibiotic protocol.</p>
    </div>

    <div class="help-card">
        <h2>Analytics</h2>
        <p>The module tracks antibiotic usage patterns for stewardship reporting:</p>
        <ul>
            <li><strong>By Antibiotic:</strong> Which medications are prescribed most/least appropriately</li>
            <li><strong>By Location:</strong> Which units have higher rates of inappropriate use</li>
            <li><strong>By Service:</strong> Which ordering services need targeted education</li>
            <li><strong>Override Rate:</strong> How often ASP reviewers disagree with AI classifications</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>Three-Layer Appropriateness Model</h2>
        <div class="layer-cards">
            <div class="layer-card layer-complete">
                <h4>Layer 1: Indication</h4>
                <p>Is there ANY indication for antibiotics?</p>
                <span class="layer-status">Implemented</span>
            </div>
            <div class="layer-card layer-planned">
                <h4>Layer 2: Agent</h4>
                <p>Is THIS antibiotic appropriate for the indication?</p>
                <span class="layer-status">Phase 2</span>
            </div>
            <div class="layer-card layer-planned">
                <h4>Layer 3: Duration</h4>
                <p>Is the DURATION appropriate?</p>
                <span class="layer-status">Phase 3</span>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>References</h2>
        <ul>
            <li>Chua KP, Fischer MA, Linder JA. Appropriateness of outpatient antibiotic prescribing among privately insured US patients: ICD-10-CM based cross sectional study. BMJ. 2019;364:k5092.</li>
            <li>ASHP/IDSA/SHEA/SIS. Clinical Practice Guidelines for Antimicrobial Prophylaxis in Surgery. 2013.</li>
            <li>The Joint Commission. MM.09.01.01 - Antimicrobial Stewardship Standard. Effective January 1, 2023.</li>
        </ul>
    </div>
</div>

<style>
.help-content {
    max-width: 900px;
}

.help-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
}

.help-card h2 {
    color: var(--color-gray-800);
    margin-top: 0;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-primary);
}

.help-card h3 {
    color: var(--color-gray-700);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}

.help-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.help-table th,
.help-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.help-table th {
    background: var(--color-gray-50);
    font-weight: 600;
    color: var(--color-gray-700);
}

.help-table-compact th,
.help-table-compact td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

.note {
    background: var(--color-info-light);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
    margin-top: 1rem;
}

/* Workflow diagram */
.workflow-diagram {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin: 1rem 0;
}

.workflow-step {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    width: 100%;
    max-width: 500px;
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
}

.step-number {
    width: 2rem;
    height: 2rem;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    flex-shrink: 0;
}

.step-content strong {
    display: block;
    margin-bottom: 0.25rem;
}

.step-content p {
    margin: 0;
    color: var(--color-gray-600);
    font-size: 0.875rem;
}

.workflow-arrow {
    color: var(--color-gray-400);
    font-size: 1.5rem;
}

/* Layer cards */
.layer-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.layer-card {
    padding: 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid;
}

.layer-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.layer-card p {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.layer-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
}

.layer-complete {
    background: var(--color-success-light);
    border-color: var(--color-success);
}

.layer-complete .layer-status {
    background: var(--color-success);
    color: white;
}

.layer-planned {
    background: var(--color-gray-100);
    border-color: var(--color-gray-400);
}

.layer-planned .layer-status {
    background: var(--color-gray-400);
    color: white;
}

/* Badges */
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-success { background: var(--color-success); color: white; }
.badge-warning { background: var(--color-warning); color: var(--color-gray-900); }
.badge-critical { background: var(--color-danger); color: white; }
.badge-info { background: var(--color-primary); color: white; }
.badge-secondary { background: var(--color-gray-400); color: white; }
</style>
{% endblock %}
