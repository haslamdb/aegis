{% extends "base.html" %}

{% block title %}Antibiotic Indications Help - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Antibiotic Indications - Help</h1>
    <a href="{{ url_for('abx_indications.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="help-content">
    <div class="help-card">
        <h2>Overview</h2>
        <p>The Antibiotic Indications module extracts clinical syndromes from notes to meet Joint Commission requirements
           for antimicrobial stewardship documentation (MM.09.01.01 EP 13-15).</p>
        <div class="key-point">
            <strong>Key Point:</strong> Joint Commission requires documentation of the <em>clinical syndrome</em>
            (e.g., "CAP", "UTI", "sepsis"), NOT ICD-10 codes or billing constructs.
        </div>
        <p>This module provides:</p>
        <ol>
            <li><strong>Clinical Syndrome Extraction</strong> - AI extracts the indication from notes (e.g., "Community-Acquired Pneumonia")</li>
            <li><strong>Guideline Matching</strong> - Maps syndrome to CCHMC treatment guidelines</li>
            <li><strong>Agent Appropriateness</strong> - Checks if prescribed antibiotic matches guideline recommendations</li>
            <li><strong>Human Review</strong> - ASP team verifies syndrome and agent appropriateness</li>
        </ol>
    </div>

    <div class="help-card">
        <h2>How It Works</h2>
        <div class="workflow-diagram">
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <strong>New Antibiotic Order</strong>
                    <p>System detects new antibiotic orders from monitored medications list</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <strong>Clinical Syndrome Extraction</strong>
                    <p>LLM extracts the clinical syndrome from notes (48h window). Example: "CAP", "pyelonephritis", "sepsis"</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <strong>Red Flag Detection</strong>
                    <p>Identifies concerning patterns: viral illness, asymptomatic bacteriuria, no documented indication</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <strong>Guideline Matching</strong>
                    <p>Maps syndrome to CCHMC guidelines. Checks if prescribed agent is first-line, alternative, or off-guideline</p>
                </div>
            </div>
            <div class="workflow-arrow">&#8595;</div>
            <div class="workflow-step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <strong>ASP Review</strong>
                    <p>Team verifies syndrome extraction and agent appropriateness. Reviews contribute to model training</p>
                </div>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>Clinical Syndrome Categories</h2>
        <p>The system recognizes ~40 clinical syndromes across these categories:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Example Syndromes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-respiratory">Respiratory</span></td>
                    <td>CAP, HAP, VAP, aspiration pneumonia, empyema</td>
                </tr>
                <tr>
                    <td><span class="badge badge-urinary">Urinary</span></td>
                    <td>Simple UTI, pyelonephritis, CAUTI</td>
                </tr>
                <tr>
                    <td><span class="badge badge-bloodstream">Bloodstream</span></td>
                    <td>Bacteremia, sepsis, line infection, endocarditis</td>
                </tr>
                <tr>
                    <td><span class="badge badge-skin">Skin/Soft Tissue</span></td>
                    <td>Cellulitis, abscess, wound infection</td>
                </tr>
                <tr>
                    <td><span class="badge badge-abdominal">Intra-abdominal</span></td>
                    <td>Appendicitis, peritonitis, C. diff</td>
                </tr>
                <tr>
                    <td><span class="badge badge-cns">CNS</span></td>
                    <td>Meningitis, VP shunt infection</td>
                </tr>
                <tr>
                    <td><span class="badge badge-bone">Bone/Joint</span></td>
                    <td>Osteomyelitis, septic arthritis</td>
                </tr>
                <tr>
                    <td><span class="badge badge-ent">ENT</span></td>
                    <td>AOM, sinusitis, strep pharyngitis</td>
                </tr>
                <tr>
                    <td><span class="badge badge-fn">Febrile Neutropenia</span></td>
                    <td>Neutropenic fever (oncology)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-prophylaxis">Prophylaxis</span></td>
                    <td>Surgical prophylaxis, PCP prophylaxis</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Red Flags (Triggers Alert)</h2>
        <p>The system flags these concerning patterns for ASP review:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Red Flag</th>
                    <th>Meaning</th>
                    <th>Example</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-critical">Likely Viral</span></td>
                    <td>Notes suggest viral illness but antibiotics prescribed</td>
                    <td>"Viral URI" or "bronchiolitis" with antibiotic order</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">Asymptomatic Bacteriuria</span></td>
                    <td>Positive UA/culture without UTI symptoms</td>
                    <td>Incidental positive UA in patient without dysuria/frequency</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">No Indication Documented</span></td>
                    <td>Notes don't explain why antibiotics started</td>
                    <td>Antibiotic order with no infection-related notes</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">Never Appropriate</span></td>
                    <td>Syndrome where antibiotics rarely/never indicated</td>
                    <td>RSV bronchiolitis, common cold</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Reviewing Extractions</h2>
        <p>When reviewing a case, you'll verify two things:</p>

        <h3>1. Syndrome Verification</h3>
        <p>Is the extracted clinical syndrome correct?</p>
        <table class="help-table help-table-compact">
            <thead>
                <tr>
                    <th>Decision</th>
                    <th>When to Use</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Confirm Syndrome</strong></td>
                    <td>LLM extraction is correct (e.g., correctly identified "CAP")</td>
                </tr>
                <tr>
                    <td><strong>Correct Syndrome</strong></td>
                    <td>Change to different syndrome (e.g., "HAP" not "CAP")</td>
                </tr>
                <tr>
                    <td><strong>No Indication</strong></td>
                    <td>No valid indication documented in notes</td>
                </tr>
                <tr>
                    <td><strong>Viral Illness</strong></td>
                    <td>Viral illness - antibiotics not indicated</td>
                </tr>
                <tr>
                    <td><strong>Asymptomatic Bacteriuria</strong></td>
                    <td>ASB - treatment not indicated</td>
                </tr>
            </tbody>
        </table>

        <h3>2. Agent Appropriateness (Optional)</h3>
        <p>Is the prescribed antibiotic appropriate for the syndrome?</p>
        <table class="help-table help-table-compact">
            <thead>
                <tr>
                    <th>Decision</th>
                    <th>When to Use</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Appropriate</strong></td>
                    <td>Good choice for this syndrome (matches guideline first-line)</td>
                </tr>
                <tr>
                    <td><strong>Acceptable</strong></td>
                    <td>Not first-line but clinically reasonable (allergy, prior treatment)</td>
                </tr>
                <tr>
                    <td><strong>Inappropriate</strong></td>
                    <td>Wrong antibiotic for this syndrome</td>
                </tr>
                <tr>
                    <td><strong>Skip</strong></td>
                    <td>Don't assess agent appropriateness</td>
                </tr>
            </tbody>
        </table>

        <p class="note"><strong>Training Data:</strong> Your reviews are collected for model fine-tuning.
           After ~500 reviewed cases, we can fine-tune a faster, specialized model.</p>
    </div>

    <div class="help-card">
        <h2>Guideline Matching</h2>
        <p>Each syndrome maps to CCHMC-specific treatment guidelines. The system checks if the prescribed antibiotic is:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Meaning</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-success">First Line</span></td>
                    <td>Matches CCHMC guideline recommendation</td>
                    <td>No intervention needed</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">Alternative</span></td>
                    <td>Acceptable alternative per guideline</td>
                    <td>Review if first-line was available</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">Off-Guideline</span></td>
                    <td>Not recommended for this syndrome</td>
                    <td>Consider intervention</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Confidence Levels</h2>
        <p>The LLM reports confidence in its syndrome extraction:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Level</th>
                    <th>Meaning</th>
                    <th>Example</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-success">Definite</span></td>
                    <td>Syndrome explicitly stated in notes</td>
                    <td>"Started ceftriaxone for CAP"</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">Probable</span></td>
                    <td>Strongly implied by clinical context</td>
                    <td>Fever + infiltrate + antibiotic, but "CAP" not stated</td>
                </tr>
                <tr>
                    <td><span class="badge badge-secondary">Unclear</span></td>
                    <td>Cannot determine from notes</td>
                    <td>Antibiotic ordered but notes don't explain why</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Three-Layer Appropriateness Model</h2>
        <div class="layer-cards">
            <div class="layer-card layer-complete">
                <h4>Layer 1: Indication</h4>
                <p>What clinical syndrome is being treated?</p>
                <span class="layer-status">Implemented</span>
            </div>
            <div class="layer-card layer-complete">
                <h4>Layer 2: Agent</h4>
                <p>Is this antibiotic appropriate for the syndrome?</p>
                <span class="layer-status">Implemented</span>
            </div>
            <div class="layer-card layer-planned">
                <h4>Layer 3: Duration</h4>
                <p>Is the duration appropriate?</p>
                <span class="layer-status">Phase 3</span>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>Fallback: ICD-10 Classification</h2>
        <p>When notes are unavailable, the system falls back to ICD-10 based classification (Chua et al.):</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Code</th>
                    <th>Meaning</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-success">Always</span></td>
                    <td>A</td>
                    <td>Antibiotic indicated per ICD-10 codes</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">Sometimes</span></td>
                    <td>S</td>
                    <td>May need antibiotics - clinical judgment required</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">Never</span></td>
                    <td>N</td>
                    <td>No antibiotic indication per ICD-10</td>
                </tr>
                <tr>
                    <td><span class="badge badge-info">Prophylaxis</span></td>
                    <td>P</td>
                    <td>Surgical or medical prophylaxis</td>
                </tr>
                <tr>
                    <td><span class="badge badge-success">Febrile Neutropenia</span></td>
                    <td>FN</td>
                    <td>Neutropenia + fever</td>
                </tr>
            </tbody>
        </table>
        <p class="note"><strong>Note:</strong> ICD-10 classification is a fallback. Clinical syndrome extraction from notes is preferred
           because it reflects real-time clinical reasoning and meets JC requirements.</p>
    </div>

    <div class="help-card">
        <h2>Analytics</h2>
        <p>The module tracks patterns for stewardship reporting:</p>
        <ul>
            <li><strong>By Syndrome:</strong> Which infections are most common</li>
            <li><strong>By Antibiotic:</strong> Agent appropriateness by medication</li>
            <li><strong>By Location:</strong> Patterns by unit/ward</li>
            <li><strong>By Service:</strong> Ordering service patterns</li>
            <li><strong>Review Metrics:</strong> Correction rate, syndrome distribution</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>References</h2>
        <ul>
            <li>The Joint Commission. MM.09.01.01 EP 13-15 - Antimicrobial Stewardship Standard. 2024 revision.</li>
            <li>CDC Core Elements of Hospital Antibiotic Stewardship Programs. 2019.</li>
            <li>IDSA/SHEA. Implementing an Antibiotic Stewardship Program: Guidelines. 2016.</li>
            <li>Chua KP, et al. Appropriateness of outpatient antibiotic prescribing. BMJ 2019;364:k5092.</li>
        </ul>
    </div>
</div>

<style>
.help-content {
    max-width: 900px;
}

.help-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
}

.help-card h2 {
    color: var(--color-gray-800);
    margin-top: 0;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-primary);
}

.help-card h3 {
    color: var(--color-gray-700);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}

.key-point {
    background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
    padding: 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
    margin: 1rem 0;
}

.help-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.help-table th,
.help-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.help-table th {
    background: var(--color-gray-50);
    font-weight: 600;
    color: var(--color-gray-700);
}

.help-table-compact th,
.help-table-compact td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

.note {
    background: var(--color-info-light);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
    margin-top: 1rem;
}

/* Workflow diagram */
.workflow-diagram {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin: 1rem 0;
}

.workflow-step {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    width: 100%;
    max-width: 500px;
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
}

.step-number {
    width: 2rem;
    height: 2rem;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    flex-shrink: 0;
}

.step-content strong {
    display: block;
    margin-bottom: 0.25rem;
}

.step-content p {
    margin: 0;
    color: var(--color-gray-600);
    font-size: 0.875rem;
}

.workflow-arrow {
    color: var(--color-gray-400);
    font-size: 1.5rem;
}

/* Layer cards */
.layer-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.layer-card {
    padding: 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid;
}

.layer-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.layer-card p {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.layer-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
}

.layer-complete {
    background: var(--color-success-light);
    border-color: var(--color-success);
}

.layer-complete .layer-status {
    background: var(--color-success);
    color: white;
}

.layer-planned {
    background: var(--color-gray-100);
    border-color: var(--color-gray-400);
}

.layer-planned .layer-status {
    background: var(--color-gray-400);
    color: white;
}

/* Badges */
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-success { background: var(--color-success); color: white; }
.badge-warning { background: var(--color-warning); color: var(--color-gray-900); }
.badge-critical { background: var(--color-danger); color: white; }
.badge-info { background: var(--color-primary); color: white; }
.badge-secondary { background: var(--color-gray-400); color: white; }

/* Category badges */
.badge-respiratory { background: #dbeafe; color: #1e40af; }
.badge-urinary { background: #fef3c7; color: #92400e; }
.badge-bloodstream { background: #fee2e2; color: #991b1b; }
.badge-skin { background: #fce7f3; color: #9d174d; }
.badge-abdominal { background: #d1fae5; color: #065f46; }
.badge-cns { background: #e0e7ff; color: #3730a3; }
.badge-bone { background: #f3e8ff; color: #6b21a8; }
.badge-ent { background: #cffafe; color: #0e7490; }
.badge-fn { background: #fef3c7; color: #92400e; }
.badge-prophylaxis { background: #f3f4f6; color: #374151; }
</style>
{% endblock %}
