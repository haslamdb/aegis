{% extends "base.html" %}

{% block title %}Guideline Adherence Help - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Guideline Adherence - Help</h1>
    <a href="{{ url_for('guideline_adherence.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="help-content">
    <div class="help-card">
        <h2>Overview</h2>
        <p>The Guideline Adherence module provides <strong>real-time monitoring</strong> of evidence-based clinical
           guideline bundles. It generates <strong>GUIDELINE_DEVIATION alerts</strong> when bundle elements are not
           completed within their time windows, and tracks <strong>aggregate compliance metrics</strong> for
           quality improvement and Joint Commission (JC) reporting.</p>
    </div>

    <div class="help-card">
        <h2>Why Separate from Antibiotic Indications?</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>Antibiotic Indications</th>
                    <th>Guideline Adherence</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Question</strong></td>
                    <td>"Is this order justified?"</td>
                    <td>"Did we follow the full pathway?"</td>
                </tr>
                <tr>
                    <td><strong>Timing</strong></td>
                    <td>Real-time (per order)</td>
                    <td>Real-time monitoring with time windows</td>
                </tr>
                <tr>
                    <td><strong>Scope</strong></td>
                    <td>Antibiotic orders only</td>
                    <td>Full care bundle (cultures, labs, imaging, consults, antibiotics)</td>
                </tr>
                <tr>
                    <td><strong>Alert Trigger</strong></td>
                    <td>No documented indication</td>
                    <td>Bundle element not completed within time window</td>
                </tr>
                <tr>
                    <td><strong>Output</strong></td>
                    <td>ASP alert for review</td>
                    <td>ASP alert + compliance metrics dashboard</td>
                </tr>
                <tr>
                    <td><strong>Audience</strong></td>
                    <td>Pharmacist, ordering provider</td>
                    <td>ASP team, QI, JC surveyors</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>How It Works - Three-Mode Monitoring Pipeline</h2>
        <p>The guideline monitoring system operates in three distinct modes that work together:</p>

        <div class="monitoring-architecture">
            <div class="architecture-row">
                <div class="architecture-box source">
                    <strong>FHIR Server</strong>
                    <span>Conditions, Medications, Labs, Vitals</span>
                </div>
            </div>
            <div class="architecture-arrow">&darr;</div>
            <div class="architecture-row">
                <div class="architecture-box mode-1">
                    <strong>Mode 1: Trigger Monitoring</strong>
                    <span><code>--trigger</code></span>
                    <ul>
                        <li>Polls FHIR for new diagnoses, orders, labs</li>
                        <li>Matches to bundle trigger criteria</li>
                        <li>Creates episodes when criteria met</li>
                    </ul>
                </div>
            </div>
            <div class="architecture-arrow">&darr;</div>
            <div class="architecture-row">
                <div class="architecture-box mode-2">
                    <strong>Mode 2: Episode Monitoring</strong>
                    <span><code>--episodes</code></span>
                    <ul>
                        <li>Reads active episodes from database</li>
                        <li>Checks element deadlines vs current time</li>
                        <li>Creates alerts for overdue/not met elements</li>
                    </ul>
                </div>
            </div>
            <div class="architecture-arrow">&darr;</div>
            <div class="architecture-row">
                <div class="architecture-box mode-3">
                    <strong>Mode 3: Adherence Checking</strong>
                    <span><code>--once</code> (default)</span>
                    <ul>
                        <li>Direct FHIR queries for patient compliance</li>
                        <li>Updates element completion status</li>
                        <li>Calculates adherence percentages</li>
                    </ul>
                </div>
            </div>
            <div class="architecture-arrow">&darr;</div>
            <div class="architecture-row outputs">
                <div class="architecture-box output-alerts">
                    <strong>ASP Alerts</strong>
                    <span>GUIDELINE_DEVIATION</span>
                </div>
                <div class="architecture-box output-dashboard">
                    <strong>Dashboard</strong>
                    <span>Compliance metrics</span>
                </div>
            </div>
        </div>

        <h3>Workflow Steps</h3>
        <div class="workflow">
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Bundle Triggered</h4>
                    <p>Trigger monitor detects qualifying condition (diagnosis, medication order, lab order, or vital sign)</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>Episode Created</h4>
                    <p>Episode stored in database with element deadlines calculated from trigger time</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Elements Monitored</h4>
                    <p>Episode monitor checks each element deadline; adherence monitor verifies completion via FHIR</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h4>Alert if Not Met</h4>
                    <p>When deadline expires without completion, a GUIDELINE_DEVIATION alert is created (CRITICAL for ABX/acyclovir delays)</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <h4>Review & Resolve</h4>
                    <p>ASP team reviews alert, documents action, resolves in ASP Alerts queue</p>
                </div>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>Available Guidelines</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Guideline</th>
                    <th>Elements</th>
                    <th>Key Metrics</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Pediatric Sepsis</strong></td>
                    <td>6</td>
                    <td>Blood culture, lactate, ABX &le;1h, fluids, reassessment</td>
                </tr>
                <tr>
                    <td><strong>Pediatric CAP</strong></td>
                    <td>6</td>
                    <td>CXR, SpO2, empiric choice, duration &le;7d</td>
                </tr>
                <tr>
                    <td><strong>Febrile Neutropenia</strong></td>
                    <td>6</td>
                    <td>Cultures, ABX &le;1h, risk stratification</td>
                </tr>
                <tr>
                    <td><strong>Surgical Prophylaxis</strong></td>
                    <td>5</td>
                    <td>Agent selection, timing &le;60min, duration &le;24h</td>
                </tr>
                <tr>
                    <td><strong>Pediatric UTI</strong></td>
                    <td>7</td>
                    <td>UA, culture, empiric choice, imaging</td>
                </tr>
                <tr>
                    <td><strong>SSTI/Cellulitis</strong></td>
                    <td>6</td>
                    <td>Margins marked, MRSA coverage, I&D if needed</td>
                </tr>
                <tr>
                    <td><strong>Febrile Infant (AAP 2021)</strong></td>
                    <td>14</td>
                    <td>UA, blood cx, inflammatory markers, LP (age-stratified), HSV risk, safe discharge</td>
                </tr>
                <tr>
                    <td><strong>Neonatal HSV (CCHMC 2024)</strong></td>
                    <td>11</td>
                    <td>CSF/blood PCR, surface cultures, LFTs, acyclovir &le;1h, ID consult, treatment duration</td>
                </tr>
                <tr>
                    <td><strong>C. diff Testing (CCHMC 2024)</strong></td>
                    <td>8</td>
                    <td>Diagnostic stewardship: age, symptoms, laxatives, risk factors, appropriateness score</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Sepsis Bundle Details (CMS SEP-1)</h2>
        <p>The Pediatric Sepsis Bundle is based on Surviving Sepsis Campaign guidelines:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Element</th>
                    <th>Time Window</th>
                    <th>Data Source</th>
                    <th>Required</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Blood culture obtained</td>
                    <td>1 hour</td>
                    <td>Lab orders (LOINC 600-7)</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>Lactate measured</td>
                    <td>3 hours</td>
                    <td>Lab results (LOINC 2524-7)</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>Antibiotics within 1h</td>
                    <td>1 hour</td>
                    <td>Medication Administration</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>Fluid bolus (if shock)</td>
                    <td>1 hour</td>
                    <td>Medication Administration</td>
                    <td>Conditional</td>
                </tr>
                <tr>
                    <td>Repeat lactate if &gt;2</td>
                    <td>6 hours</td>
                    <td>Lab results</td>
                    <td>Conditional</td>
                </tr>
                <tr>
                    <td>48h reassessment</td>
                    <td>72 hours</td>
                    <td>Clinical notes</td>
                    <td>Yes</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Febrile Infant Bundle Details (AAP 2021)</h2>
        <p>The Febrile Infant Bundle implements the AAP Clinical Practice Guideline for well-appearing febrile infants 8-60 days old:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Age Group</th>
                    <th>LP Required</th>
                    <th>Antibiotics</th>
                    <th>Disposition</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>8-21 days</td>
                    <td>Yes (all)</td>
                    <td>Yes - parenteral</td>
                    <td>Admit all</td>
                </tr>
                <tr>
                    <td>22-28 days, IMs abnormal</td>
                    <td>Yes</td>
                    <td>Yes - parenteral</td>
                    <td>Admit</td>
                </tr>
                <tr>
                    <td>22-28 days, IMs normal</td>
                    <td>Consider</td>
                    <td>Consider</td>
                    <td>Home with close f/u acceptable</td>
                </tr>
                <tr>
                    <td>29-60 days, IMs abnormal</td>
                    <td>Consider</td>
                    <td>Yes</td>
                    <td>Varies</td>
                </tr>
                <tr>
                    <td>29-60 days, IMs normal</td>
                    <td>Not required</td>
                    <td>If UTI only</td>
                    <td>Home observation acceptable</td>
                </tr>
            </tbody>
        </table>
        <p><strong>Inflammatory Marker Thresholds (Abnormal):</strong></p>
        <ul>
            <li>Procalcitonin &gt; 0.5 ng/mL</li>
            <li>ANC &gt; 4,000/&mu;L</li>
            <li>CRP &gt; 2.0 mg/dL</li>
        </ul>
        <p><strong>HSV Risk Integration (CCHMC Enhancement):</strong> For infants 0-28 days, HSV risk factors are automatically detected:</p>
        <ul>
            <li>Maternal HSV history</li>
            <li>Scalp electrode use</li>
            <li>Vesicular rash</li>
            <li>Seizures</li>
            <li>CSF pleocytosis</li>
            <li>Elevated LFTs (&gt;3x ULN)</li>
        </ul>
        <p>If risk factors present &rarr; Acyclovir administration is tracked as a required element.</p>

        <p><strong>Safe Discharge Checklist (CCHMC Enhancement):</strong> For infants being discharged home, tracks 5 safety elements:</p>
        <ol>
            <li>Follow-up within 24h arranged</li>
            <li>Working phone number documented</li>
            <li>Reliable transportation confirmed</li>
            <li>Parent education completed</li>
            <li>Return precautions verbalized</li>
        </ol>
    </div>

    <div class="help-card">
        <h2>Neonatal HSV Bundle Details (CCHMC 2024)</h2>
        <p>Comprehensive monitoring for suspected HSV in neonates &le;21 days. Triggered by HSV diagnosis, acyclovir order, or HSV PCR order.</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Element</th>
                    <th>Time Window</th>
                    <th>Required</th>
                    <th>Data Source</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>CSF HSV PCR</td>
                    <td>4 hours</td>
                    <td>Yes</td>
                    <td>Lab orders (LOINC 16955-7)</td>
                </tr>
                <tr>
                    <td>Surface cultures (SEM)</td>
                    <td>4 hours</td>
                    <td>Yes</td>
                    <td>Lab orders</td>
                </tr>
                <tr>
                    <td>Blood HSV PCR</td>
                    <td>4 hours</td>
                    <td>Yes</td>
                    <td>Lab orders (LOINC 49986-3)</td>
                </tr>
                <tr>
                    <td>LFTs obtained</td>
                    <td>4 hours</td>
                    <td>Yes</td>
                    <td>Lab results (AST, ALT)</td>
                </tr>
                <tr>
                    <td>Acyclovir started</td>
                    <td>1 hour</td>
                    <td>Yes</td>
                    <td>Medication Administration</td>
                </tr>
                <tr>
                    <td>Acyclovir 60mg/kg/day Q8H</td>
                    <td>24 hours</td>
                    <td>Yes</td>
                    <td>Medication orders</td>
                </tr>
                <tr>
                    <td>ID consult</td>
                    <td>24 hours</td>
                    <td>Yes</td>
                    <td>Consult orders</td>
                </tr>
                <tr>
                    <td>Ophthalmology (if ocular)</td>
                    <td>48 hours</td>
                    <td>Conditional</td>
                    <td>Consult orders</td>
                </tr>
                <tr>
                    <td>Neuroimaging (if CNS)</td>
                    <td>48 hours</td>
                    <td>Conditional</td>
                    <td>Imaging orders</td>
                </tr>
                <tr>
                    <td>Treatment duration met</td>
                    <td>End of therapy</td>
                    <td>Yes</td>
                    <td>Medication orders</td>
                </tr>
                <tr>
                    <td>Suppressive therapy follow-up</td>
                    <td>Discharge</td>
                    <td>Yes</td>
                    <td>Clinical notes</td>
                </tr>
            </tbody>
        </table>
        <p><strong>Classification-Based Treatment Duration:</strong></p>
        <ul>
            <li><strong>SEM (Skin, Eye, Mouth):</strong> 14 days</li>
            <li><strong>CNS disease:</strong> 21 days</li>
            <li><strong>Disseminated:</strong> 21 days</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>C. diff Testing Appropriateness Bundle (CCHMC 2024)</h2>
        <p>Diagnostic stewardship bundle to ensure C. diff testing criteria are met before ordering. Triggered when a C. diff test is ordered.</p>

        <h3>Appropriateness Criteria</h3>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Criterion</th>
                    <th>Requirement</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Age</td>
                    <td>&ge;3 years (or exception documented)</td>
                </tr>
                <tr>
                    <td>Symptoms</td>
                    <td>&ge;3 liquid stools in 24 hours</td>
                </tr>
                <tr>
                    <td>No laxatives</td>
                    <td>Not given within 48 hours</td>
                </tr>
                <tr>
                    <td>No enteral contrast</td>
                    <td>Not given within 48 hours</td>
                </tr>
                <tr>
                    <td>No tube feed changes</td>
                    <td>Not changed within 48 hours</td>
                </tr>
                <tr>
                    <td>No active GI bleed</td>
                    <td>Documented absence</td>
                </tr>
                <tr>
                    <td>Risk factor present</td>
                    <td>Antibiotics, hospitalization, PPI, gastrostomy, or chronic disease</td>
                </tr>
                <tr>
                    <td>Symptom duration</td>
                    <td>&ge;48 hours if low-risk patient</td>
                </tr>
            </tbody>
        </table>

        <h3>Appropriateness Classification</h3>
        <ul>
            <li><strong class="status-met">Appropriate:</strong> All criteria met</li>
            <li><strong class="status-warning">Potentially Inappropriate:</strong> 1-2 concerns</li>
            <li><strong class="status-not-met">Inappropriate:</strong> 3+ concerns or major exclusion</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>NLP Clinical Note Analysis</h2>
        <p>The system uses <strong>LLM-based Natural Language Processing</strong> to extract clinical information
           from unstructured notes that cannot be reliably captured with simple keyword matching.</p>

        <h3>Clinical Impression Extraction (Febrile Infant)</h3>
        <p>Critical for risk stratification in the Febrile Infant guideline. The LLM analyzes clinical notes to determine:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Assessment</th>
                    <th>Indicators</th>
                    <th>Clinical Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong class="status-met">Well-Appearing</strong></td>
                    <td>Alert, playful, active, feeding well, good eye contact, pink, well-perfused</td>
                    <td>Follow standard age-stratified pathway</td>
                </tr>
                <tr>
                    <td><strong class="status-warning">Ill-Appearing</strong></td>
                    <td>Lethargic, irritable, poor feeding, mottled, pale, decreased activity, fussy</td>
                    <td>Higher risk stratification, consider HSV workup</td>
                </tr>
                <tr>
                    <td><strong class="status-not-met">Toxic-Appearing</strong></td>
                    <td>Obtunded, unresponsive, septic appearance, shock, poor perfusion, inconsolable</td>
                    <td>Full sepsis workup, aggressive resuscitation</td>
                </tr>
            </tbody>
        </table>

        <h3>GI Symptom Extraction (C. diff Testing)</h3>
        <p>Extracts precise symptom information for C. diff testing appropriateness:</p>
        <ul>
            <li><strong>Stool count:</strong> Exact number of stools in past 24 hours</li>
            <li><strong>Stool consistency:</strong> Liquid, watery, loose, soft, or formed</li>
            <li><strong>Symptom duration:</strong> When diarrhea started (converted to hours)</li>
            <li><strong>Associated symptoms:</strong> Abdominal pain, cramping, fever, bloody stool</li>
        </ul>

        <h3>NLP Configuration</h3>
        <p>The NLP module uses a local LLM via <strong>Ollama</strong> for HIPAA-compliant processing:</p>
        <pre class="code-block">
# Check LLM availability
python -c "from guideline_src.nlp.clinical_impression import check_llm_availability; print(check_llm_availability())"

# Test clinical impression extraction
python -m guideline_src.nlp.clinical_impression

# Test GI symptom extraction
python -m guideline_src.nlp.gi_symptoms</pre>

        <p><strong>Fallback:</strong> If LLM is unavailable, the system falls back to keyword-based matching
           with reduced accuracy. NLP extraction adds HIGH/MEDIUM confidence levels, while keyword matching
           is tagged with LOW/MEDIUM confidence.</p>
    </div>

    <div class="help-card">
        <h2>Running the Monitor</h2>

        <h3>Mode 1: Trigger Monitoring</h3>
        <p>Polls FHIR for new patients matching bundle trigger criteria and creates episodes.</p>
        <pre class="code-block">
cd /home/david/projects/aegis/guideline-adherence

# Poll once for new triggers
python -m guideline_src.runner --trigger --once

# Poll continuously (every 60 seconds)
python -m guideline_src.runner --trigger --daemon --interval 60

# Show monitoring status
python -m guideline_src.runner --trigger --status

# Use real FHIR connection
python -m guideline_src.runner --trigger --daemon --use-fhir</pre>

        <h3>Mode 2: Episode Monitoring</h3>
        <p>Checks active episodes for compliance and creates alerts for overdue elements.</p>
        <pre class="code-block">
# Check all active episodes once
python -m guideline_src.runner --episodes --once

# Run as daemon (every 5 minutes)
python -m guideline_src.runner --episodes --daemon --interval 5

# Show episode status (active episodes, pending elements, alerts)
python -m guideline_src.runner --episodes --status

# Verbose output (shows all element checks)
python -m guideline_src.runner --episodes --once --verbose</pre>

        <h3>Mode 3: Adherence Checking</h3>
        <p>Direct FHIR queries to verify element completion and calculate adherence.</p>
        <pre class="code-block">
# Check all active episodes once
python -m guideline_src.runner --once

# Run for specific bundle only
python -m guideline_src.runner --once --bundle sepsis_peds_2024

# Dry run (no alerts created)
python -m guideline_src.runner --once --dry-run --verbose

# Run as daemon (every 15 minutes)
python -m guideline_src.runner --daemon --interval 15</pre>

        <h3>Utility Commands</h3>
        <pre class="code-block">
# List available bundles
python -m guideline_src.runner --list-bundles

# Create demo patients for testing
python demo_patients.py</pre>

        <h3>Cron Setup (Production)</h3>
        <pre class="code-block">
# Trigger monitoring - poll for new patients every minute
* * * * * cd /home/david/projects/aegis/guideline-adherence && \
    python -m guideline_src.runner --trigger --once --use-fhir \
    >> /var/log/aegis/trigger-monitor.log 2>&1

# Episode monitoring - check for overdue elements every 5 minutes
*/5 * * * * cd /home/david/projects/aegis/guideline-adherence && \
    python -m guideline_src.runner --episodes --once \
    >> /var/log/aegis/episode-monitor.log 2>&1

# Adherence checking - full compliance check every 15 minutes
*/15 * * * * cd /home/david/projects/aegis/guideline-adherence && \
    python -m guideline_src.runner --once \
    >> /var/log/aegis/guideline-adherence.log 2>&1</pre>
    </div>

    <div class="help-card">
        <h2>Alert Content</h2>
        <p>GUIDELINE_DEVIATION alerts appear in ASP Alerts and include:</p>
        <ul>
            <li><strong>Bundle Info:</strong> Which guideline bundle triggered the alert</li>
            <li><strong>Element Details:</strong> Specific element that was not met</li>
            <li><strong>Time Window:</strong> Required completion timeframe and when it expired</li>
            <li><strong>Recommendation:</strong> Suggested action for ASP team</li>
            <li><strong>Overall Adherence:</strong> Current compliance percentage for this episode</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>LLM Review Workflow</h2>
        <p>The system uses an <strong>HAI-style automated review workflow</strong> with LLM-based analysis and human oversight.</p>

        <h3>Automatic Analysis</h3>
        <p>When a guideline episode is created, the system automatically:</p>
        <ol>
            <li>Retrieves clinical notes from FHIR (DocumentReference resources)</li>
            <li>Runs LLM analysis using tiered extraction (fast 7B triage → optional 70B full analysis)</li>
            <li>Determines overall guideline adherence (appropriate, deviation, or pending)</li>
            <li>Saves assessment with confidence level and supporting evidence</li>
        </ol>
        <p>No manual "Run LLM" button required - analysis happens on episode creation and can be re-run periodically.</p>

        <h3>Episode Review Interface</h3>
        <p>The episode detail page provides an HAI-style two-column layout:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Left Column (Information)</th>
                    <th>Right Column (Actions)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Patient information (MRN, age, location)</td>
                    <td>Reviewer name input</td>
                </tr>
                <tr>
                    <td>Bundle information (trigger, time)</td>
                    <td>Decision buttons (Appropriate / Deviation / Needs Info)</td>
                </tr>
                <tr>
                    <td>LLM assessment (determination, confidence, reasoning)</td>
                    <td>Override reason dropdown (when applicable)</td>
                </tr>
                <tr>
                    <td>Bundle elements (met/not_met/pending status)</td>
                    <td>Deviation type dropdown (for deviations)</td>
                </tr>
                <tr>
                    <td>Review history</td>
                    <td>Notes and submit button</td>
                </tr>
            </tbody>
        </table>

        <h3>Override Detection</h3>
        <p>The system automatically detects when human judgment differs from automated assessment:</p>
        <ul>
            <li><strong>Direct Override:</strong> LLM says "appropriate" but human says "deviation" (or vice versa)</li>
            <li><strong>System Override:</strong> LLM says "pending" but there are not_met elements, and human says "appropriate"</li>
        </ul>
        <p>When an override is detected, the system shows an <strong>Override Reason dropdown</strong> to capture why the human disagrees. This data is logged for training improvement.</p>

        <h3>Override Reason Categories</h3>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Extraction Error</td>
                    <td>LLM misread clinical documentation</td>
                </tr>
                <tr>
                    <td>Element Detection Error</td>
                    <td>LLM missed or incorrectly detected an element</td>
                </tr>
                <tr>
                    <td>Timing Error</td>
                    <td>LLM got timing/sequence wrong</td>
                </tr>
                <tr>
                    <td>Clinical Judgment</td>
                    <td>Clinical context not captured in notes</td>
                </tr>
                <tr>
                    <td>Documentation Gap</td>
                    <td>Key documentation not available</td>
                </tr>
                <tr>
                    <td>Rule Interpretation</td>
                    <td>Different interpretation of guideline</td>
                </tr>
                <tr>
                    <td>Patient Specific</td>
                    <td>Patient-specific factors justify deviation</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Training Data Collection</h2>
        <p>The system captures training data for future LLM fine-tuning, following the same pattern as HAI Detection.</p>

        <h3>What Gets Logged</h3>
        <ul>
            <li><strong>Clinical Appearance Extractions:</strong> Every LLM extraction is logged to <code>clinical_appearance_{YYYY_MM}.jsonl</code></li>
            <li><strong>Guideline Reviews:</strong> Human review decisions are logged to <code>guideline_reviews_{YYYY_MM}.jsonl</code></li>
            <li><strong>Overrides:</strong> Discrepancies between LLM and human are flagged for training priority</li>
        </ul>

        <h3>Training Stats Dashboard</h3>
        <p>Access via: <a href="/guideline-adherence/training/stats">/guideline-adherence/training/stats</a></p>
        <p>The training stats page shows:</p>
        <ul>
            <li><strong>Total Extractions:</strong> Number of LLM extractions performed</li>
            <li><strong>Human Reviewed:</strong> Count and percentage of extractions reviewed by humans</li>
            <li><strong>Correction Rate:</strong> Percentage of reviewed cases where human corrected the LLM</li>
            <li><strong>Triage Performance:</strong> Fast path rate (7B model sufficient) vs escalated (needed 70B)</li>
            <li><strong>Response Times:</strong> Average triage and full extraction latency</li>
            <li><strong>Appearance Distribution:</strong> Well/Ill/Toxic breakdown</li>
            <li><strong>Override Reasons:</strong> Distribution of why humans disagreed with LLM</li>
            <li><strong>Training Readiness:</strong> Whether enough data exists for fine-tuning (target: 100+ reviewed)</li>
        </ul>

        <h3>Export for Fine-Tuning</h3>
        <pre class="code-block">
cd /home/david/projects/aegis/guideline-adherence

# Export clinical appearance training data
python -c "
from guideline_src.nlp.training_collector import get_training_collector
collector = get_training_collector()
count = collector.export_training_data('training_export.jsonl', reviewed_only=True)
print(f'Exported {count} training examples')
"

# Export guideline review data
python -c "
from guideline_src.nlp.training_collector import get_guideline_review_collector
collector = get_guideline_review_collector()
count = collector.export_training_data('guideline_reviews_export.jsonl')
print(f'Exported {count} guideline reviews')
"</pre>
    </div>

    <div class="help-card">
        <h2>Dashboard Pages</h2>

        <h3>Active Episodes</h3>
        <p>URL: <a href="/guideline-adherence/active">/guideline-adherence/active</a></p>
        <p>Shows episodes currently being monitored (not yet reviewed). Features:</p>
        <ul>
            <li>Filter by bundle type</li>
            <li>Patient info, bundle, trigger time</li>
            <li>Adherence percentage (color-coded: green ≥90%, yellow ≥70%, red &lt;70%)</li>
            <li>LLM Analysis status (determination + confidence, or "Not Analyzed")</li>
            <li>Review and Details action buttons</li>
        </ul>
        <p><strong>Note:</strong> Reviewed episodes are automatically removed from this list.</p>

        <h3>History</h3>
        <p>URL: <a href="/guideline-adherence/history">/guideline-adherence/history</a></p>
        <p>Shows all episodes (both active and completed). Features:</p>
        <ul>
            <li>Filter by bundle type and status (all/active/completed)</li>
            <li>Same columns as Active Episodes plus review status</li>
            <li>Useful for auditing past cases</li>
        </ul>

        <h3>Compliance Metrics</h3>
        <p>URL: <a href="/guideline-adherence/metrics">/guideline-adherence/metrics</a></p>
        <ul>
            <li>Filter by bundle and time period (7/30/90/365 days)</li>
            <li>Episode counts (total, active, completed)</li>
            <li>Element-level compliance rates <strong>grouped by bundle</strong></li>
            <li>Visual compliance bars (color-coded by rate)</li>
        </ul>

        <h3>Episode Detail / Review</h3>
        <p>URL: <code>/guideline-adherence/episode/{id}/detail</code></p>
        <p>HAI-style review interface with:</p>
        <ul>
            <li>Full patient and bundle information</li>
            <li>LLM assessment with reasoning and evidence</li>
            <li>Element-by-element status with values and notes</li>
            <li>Review decision workflow with override detection</li>
            <li>Success state after submission</li>
        </ul>

        <h3>Training Stats</h3>
        <p>URL: <a href="/guideline-adherence/training/stats">/guideline-adherence/training/stats</a></p>
        <p>Analytics for LLM training data collection (see Training Data Collection section above).</p>
    </div>

    <div class="help-card">
        <h2>Running the Assessment Monitor</h2>
        <p>The assessment monitor runs LLM analysis on episodes. Use the <code>run_monitor.py</code> script:</p>

        <pre class="code-block">
cd /home/david/projects/aegis/guideline-adherence

# Run assessment on all unprocessed episodes (one-time)
python run_monitor.py --assess

# Run full monitor (trigger detection + assessment)
python run_monitor.py --once

# Run as daemon with periodic reassessment
python run_monitor.py --interval 60

# Options:
#   --assess   Only run LLM assessment on pending episodes
#   --once     Run once and exit
#   --interval Run continuously with N second interval</pre>

        <h3>Demo Data with FHIR Notes</h3>
        <p>Create demo patients with clinical notes stored in FHIR for LLM parsing:</p>
        <pre class="code-block">
cd /home/david/projects/aegis/guideline-adherence

# Create demo patients with FHIR clinical notes
python demo_patients.py --persist --fhir --clear

# Then run assessment
python run_monitor.py --assess</pre>
    </div>

    <div class="help-card">
        <h2>Joint Commission (JC) Compliance</h2>
        <p>This module supports MM.09.01.01 EP 18-19 compliance by:</p>
        <ul>
            <li>Implementing evidence-based guidelines for infectious disease treatment</li>
            <li>Real-time monitoring of antimicrobial stewardship protocols</li>
            <li>Generating aggregate compliance metrics for quality improvement</li>
            <li>Providing drill-down capability to individual episodes</li>
            <li>Documenting interventions through the alert resolution workflow</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>References</h2>
        <ul>
            <li>Surviving Sepsis Campaign. International Guidelines for Management of Sepsis and Septic Shock. 2021.</li>
            <li>AAP Clinical Practice Guideline. Evaluation and Management of Well-Appearing Febrile Infants 8 to 60 Days Old. <em>Pediatrics</em>. August 2021.</li>
            <li>Kimberlin DW. Neonatal herpes simplex infection. <em>Clin Microbiol Rev</em>. 2004.</li>
            <li>IDSA/SHEA. Clinical Practice Guidelines for <em>Clostridium difficile</em> Infection. 2018.</li>
            <li>CCHMC Pocket Docs. Bugs & Drugs Guidelines, Neonatal HSV Algorithm, C. diff Testing Algorithm. 2024.</li>
            <li>Bradley JS, et al. The Management of Community-Acquired Pneumonia in Infants and Children Older Than 3 Months of Age: PIDS and IDSA. <em>Clin Infect Dis</em>. 2011.</li>
            <li>The Joint Commission. MM.09.01.01 - Antimicrobial Stewardship Standard. Effective January 1, 2023.</li>
            <li>CMS Severe Sepsis and Septic Shock Early Management Bundle (SEP-1).</li>
        </ul>
    </div>
</div>

<style>
.help-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 1.5rem;
}

.help-card h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--color-gray-800);
    border-bottom: 2px solid var(--color-primary);
    padding-bottom: 0.5rem;
}

.help-card h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-gray-700);
}

.help-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.help-table th,
.help-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.help-table th {
    background: var(--color-gray-50);
    font-weight: 600;
}

.workflow {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 1rem 0;
}

.workflow-step {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}

.step-number {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.step-content h4 {
    margin: 0;
}

.step-content p {
    margin: 0.25rem 0 0;
    color: var(--color-gray-600);
}

.code-block {
    background: var(--color-gray-800);
    color: var(--color-gray-100);
    padding: 1rem;
    border-radius: var(--radius-md);
    overflow-x: auto;
    font-size: 0.875rem;
    font-family: monospace;
    white-space: pre;
    margin: 0.5rem 0;
}

/* Monitoring Architecture Diagram */
.monitoring-architecture {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-md);
}

.architecture-row {
    display: flex;
    justify-content: center;
    gap: 1rem;
}

.architecture-row.outputs {
    gap: 2rem;
}

.architecture-arrow {
    text-align: center;
    font-size: 1.5rem;
    color: var(--color-gray-400);
    margin: 0.5rem 0;
}

.architecture-box {
    background: white;
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    padding: 1rem;
    min-width: 280px;
    text-align: center;
}

.architecture-box strong {
    display: block;
    font-size: 1rem;
    margin-bottom: 0.25rem;
}

.architecture-box span {
    display: block;
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.architecture-box code {
    background: var(--color-gray-100);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
}

.architecture-box ul {
    text-align: left;
    margin: 0.75rem 0 0;
    padding-left: 1.25rem;
    font-size: 0.8rem;
    color: var(--color-gray-700);
}

.architecture-box ul li {
    margin: 0.25rem 0;
}

.architecture-box.source {
    border-color: var(--color-info);
    background: #e7f3ff;
}

.architecture-box.mode-1 {
    border-color: #10b981;
    background: #ecfdf5;
}

.architecture-box.mode-2 {
    border-color: #f59e0b;
    background: #fffbeb;
}

.architecture-box.mode-3 {
    border-color: #8b5cf6;
    background: #f5f3ff;
}

.architecture-box.output-alerts {
    border-color: var(--color-danger);
    background: #fef2f2;
    min-width: 150px;
}

.architecture-box.output-dashboard {
    border-color: var(--color-primary);
    background: #eff6ff;
    min-width: 150px;
}

/* Status colors for C. diff appropriateness */
.status-met {
    color: #059669;
}

.status-warning {
    color: #d97706;
}

.status-not-met {
    color: #dc2626;
}
</style>
{% endblock %}
