{% extends "base.html" %}

{% block title %}Episode Detail - Guideline Adherence - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Episode Detail</h1>
    <a href="{{ url_for('guideline_adherence.active_episodes') }}" class="btn btn-secondary">Back to Active Episodes</a>
</div>

<div class="episode-header">
    <div class="patient-info-card">
        <h2>{{ episode.patient_name or 'Unknown Patient' }}</h2>
        {% if episode.patient_mrn %}
        <p class="patient-mrn">MRN: {{ episode.patient_mrn }}</p>
        {% endif %}
        {% if episode.location %}
        <p class="patient-location">Location: {{ episode.location }}</p>
        {% endif %}
    </div>

    <div class="episode-meta">
        <div class="meta-item">
            <span class="meta-label">Bundle</span>
            <span class="meta-value">{{ episode.bundle_name or episode.bundle_id }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Trigger Time</span>
            <span class="meta-value">{{ episode.trigger_time[:19] if episode.trigger_time else '-' }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Status</span>
            <span class="badge badge-status-{{ episode.status }}">{{ episode.status }}</span>
        </div>
    </div>
</div>

<!-- LLM Clinical Assessment -->
{% if nlp_assessment %}
<div class="section">
    <h3>LLM Clinical Assessment</h3>

    {% if nlp_assessment.clinical_impression %}
    <div class="classification-item">
        <div class="classification-header">
            <span class="badge badge-{{ 'danger' if nlp_assessment.clinical_impression.is_high_risk else 'success' }}">
                {{ nlp_assessment.clinical_impression.appearance|replace('_', '-')|title }}
            </span>
            <span class="confidence">{{ nlp_assessment.clinical_impression.confidence }} confidence</span>
            <span class="text-muted">Source: {{ nlp_assessment.clinical_impression_source|default('NLP')|upper }}</span>
        </div>

        {% if nlp_assessment.clinical_impression.is_high_risk %}
        <div class="classification-reasoning">
            <strong>Risk Assessment:</strong>
            <p>Infant appears ill-appearing based on clinical documentation. Consider higher-risk pathway and HSV workup if age-appropriate.</p>
        </div>
        {% else %}
        <div class="classification-reasoning">
            <strong>Risk Assessment:</strong>
            <p>Infant appears well-appearing based on clinical documentation. Standard age-stratified pathway appropriate.</p>
        </div>
        {% endif %}

        {% if nlp_assessment.clinical_impression.concerning_signs %}
        <div class="evidence evidence-contradicting">
            <strong>Concerning Signs:</strong>
            <ul>
            {% for sign in nlp_assessment.clinical_impression.concerning_signs[:5] %}
                <li>
                    <span class="evidence-text">{{ sign }}</span>
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if nlp_assessment.clinical_impression.reassuring_signs %}
        <div class="evidence evidence-supporting">
            <strong>Reassuring Signs:</strong>
            <ul>
            {% for sign in nlp_assessment.clinical_impression.reassuring_signs[:5] %}
                <li>
                    <span class="evidence-text">{{ sign }}</span>
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if nlp_assessment.clinical_impression.supporting_quotes %}
        <div class="evidence evidence-quotes">
            <strong>Supporting Quotes from Notes:</strong>
            <ul>
            {% for quote in nlp_assessment.clinical_impression.supporting_quotes[:3] %}
                <li>
                    <span class="evidence-text">"{{ quote }}"</span>
                    <br><small class="evidence-source">Source: Clinical Notes</small>
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="classification-meta">
            <small>Model: {{ nlp_assessment.clinical_impression.model_used|default('llama3.3:70b') }}
            {% if nlp_assessment.clinical_impression.response_time_ms %}
            | Response time: {{ nlp_assessment.clinical_impression.response_time_ms }}ms
            {% endif %}
            </small>
        </div>
    </div>
    {% endif %}

    {% if nlp_assessment.gi_symptoms %}
    <div class="classification-item">
        <div class="classification-header">
            <span class="badge badge-{{ 'success' if nlp_assessment.gi_symptoms.meets_cdiff_criteria else 'warning' }}">
                {% if nlp_assessment.gi_symptoms.meets_cdiff_criteria %}Criteria Met{% else %}Criteria Not Met{% endif %}
            </span>
            <span class="confidence">{{ nlp_assessment.gi_symptoms.confidence }} confidence</span>
            <span class="text-muted">GI Symptom Assessment</span>
        </div>

        <div class="classification-reasoning">
            <strong>C. diff Testing Appropriateness:</strong>
            <p>
                {% if nlp_assessment.gi_symptoms.stool_count_24h %}
                    {{ nlp_assessment.gi_symptoms.stool_count_24h }} {{ nlp_assessment.gi_symptoms.stool_consistency|replace('_', ' ') }} stools in 24 hours.
                {% else %}
                    Stool count not clearly documented.
                {% endif %}
                {% if nlp_assessment.gi_symptoms.symptom_duration_hours %}
                    Symptoms present for {{ nlp_assessment.gi_symptoms.symptom_duration_hours|round|int }} hours.
                {% endif %}
            </p>
        </div>

        <div class="evidence evidence-supporting">
            <strong>Symptoms Identified:</strong>
            <ul>
                {% if nlp_assessment.gi_symptoms.has_diarrhea %}<li><span class="evidence-text">Diarrhea documented</span></li>{% endif %}
                {% if nlp_assessment.gi_symptoms.has_abdominal_pain %}<li><span class="evidence-text">Abdominal pain present</span></li>{% endif %}
                {% if nlp_assessment.gi_symptoms.has_cramping %}<li><span class="evidence-text">Cramping noted</span></li>{% endif %}
                {% if nlp_assessment.gi_symptoms.has_fever %}<li><span class="evidence-text">Fever present</span></li>{% endif %}
                {% if nlp_assessment.gi_symptoms.has_bloody_stool %}<li><span class="evidence-text" style="color: var(--color-danger);">Bloody stool - evaluate for other causes</span></li>{% endif %}
            </ul>
        </div>

        {% if nlp_assessment.gi_symptoms.supporting_quotes %}
        <div class="evidence evidence-quotes">
            <strong>Supporting Quotes from Notes:</strong>
            <ul>
            {% for quote in nlp_assessment.gi_symptoms.supporting_quotes[:2] %}
                <li>
                    <span class="evidence-text">"{{ quote }}"</span>
                    <br><small class="evidence-source">Source: Clinical Notes</small>
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="classification-meta">
            <small>Model: {{ nlp_assessment.gi_symptoms.model_used|default('llama3.3:70b') }}
            {% if nlp_assessment.gi_symptoms.response_time_ms %}
            | Response time: {{ nlp_assessment.gi_symptoms.response_time_ms }}ms
            {% endif %}
            </small>
        </div>
    </div>
    {% endif %}

    {% if not nlp_assessment.clinical_impression and not nlp_assessment.gi_symptoms %}
    <p class="text-muted" style="text-align: center; padding: 1rem;">No LLM assessments available for this episode.</p>
    {% endif %}
</div>
{% endif %}

<!-- Adherence Summary -->
<div class="adherence-summary">
    {% set met = results|selectattr('status', 'equalto', 'met')|list|length %}
    {% set not_met = results|selectattr('status', 'equalto', 'not_met')|list|length %}
    {% set pending = results|selectattr('status', 'equalto', 'pending')|list|length %}
    {% set na = results|selectattr('status', 'equalto', 'na')|list|length %}
    {% set total = met + not_met %}
    {% set pct = ((met / total) * 100)|round(1) if total > 0 else 100 %}

    <div class="summary-stat">
        <div class="stat-value {% if pct >= 90 %}success{% elif pct >= 70 %}warning{% else %}danger{% endif %}">{{ pct }}%</div>
        <div class="stat-label">Compliance</div>
    </div>
    <div class="summary-stat">
        <div class="stat-value success">{{ met }}</div>
        <div class="stat-label">Met</div>
    </div>
    <div class="summary-stat">
        <div class="stat-value danger">{{ not_met }}</div>
        <div class="stat-label">Not Met</div>
    </div>
    <div class="summary-stat">
        <div class="stat-value warning">{{ pending }}</div>
        <div class="stat-label">Pending</div>
    </div>
</div>

<!-- Element Results -->
<div class="section">
    <h3>Bundle Elements</h3>
    <div class="elements-list">
        {% for result in results %}
        <div class="element-item status-{{ result.status }}">
            <div class="element-status">
                {% if result.status == 'met' %}
                    <span class="status-icon met">&#x2713;</span>
                {% elif result.status == 'not_met' %}
                    <span class="status-icon not-met">&#x2717;</span>
                {% elif result.status == 'pending' %}
                    <span class="status-icon pending">&#x25CB;</span>
                {% else %}
                    <span class="status-icon na">-</span>
                {% endif %}
            </div>
            <div class="element-details">
                <div class="element-name">{{ result.element_name or result.element_id }}</div>
                <div class="element-meta">
                    {% if result.time_window_hours %}
                    <span>Window: {{ result.time_window_hours }}h</span>
                    {% endif %}
                    {% if result.deadline %}
                    <span>Deadline: {{ result.deadline[:16] }}</span>
                    {% endif %}
                    {% if result.completed_at %}
                    <span>Completed: {{ result.completed_at[:16] }}</span>
                    {% endif %}
                </div>
                {% if result.notes %}
                <div class="element-notes">{{ result.notes }}</div>
                {% endif %}
                {% if result.value %}
                <div class="element-value">Value: {{ result.value }}</div>
                {% endif %}
            </div>
            <div class="element-badge">
                <span class="badge badge-{{ result.status }}">{{ result.status|upper }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bundle Reference -->
{% if bundle %}
<div class="section">
    <h3>Bundle Reference: {{ bundle.name }}</h3>
    <p>{{ bundle.description }}</p>
    {% if bundle.references %}
    <div class="references">
        <strong>References:</strong>
        <ul>
            {% for ref in bundle.references %}
            <li>{{ ref }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<style>
.episode-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
}

.patient-info-card h2 {
    margin: 0 0 0.5rem 0;
    color: var(--color-gray-800);
}

.patient-info-card .patient-mrn,
.patient-info-card .patient-location {
    margin: 0.25rem 0;
    color: var(--color-gray-600);
    font-size: 0.875rem;
}

.episode-meta {
    display: flex;
    gap: 2rem;
}

.meta-item {
    text-align: right;
}

.meta-label {
    display: block;
    font-size: 0.75rem;
    color: var(--color-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.meta-value {
    font-weight: 600;
    color: var(--color-gray-800);
}

.adherence-summary {
    display: flex;
    gap: 2rem;
    padding: 1.5rem;
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: 1.5rem;
}

.summary-stat {
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
}

.stat-value.success { color: var(--color-success); }
.stat-value.warning { color: var(--color-warning); }
.stat-value.danger { color: var(--color-danger); }

.stat-label {
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.section {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 1.5rem;
}

.section h3 {
    margin-top: 0;
    margin-bottom: 1rem;
}

.elements-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.element-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-gray-300);
}

.element-item.status-met { border-left-color: var(--color-success); background: var(--color-success-light); }
.element-item.status-not_met { border-left-color: var(--color-danger); background: var(--color-danger-light); }
.element-item.status-pending { border-left-color: var(--color-warning); background: var(--color-warning-light); }
.element-item.status-na { border-left-color: var(--color-gray-400); background: var(--color-gray-100); }

.element-status {
    flex-shrink: 0;
}

.status-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    font-weight: bold;
}

.status-icon.met { background: var(--color-success); color: white; }
.status-icon.not-met { background: var(--color-danger); color: white; }
.status-icon.pending { background: var(--color-warning); color: white; }
.status-icon.na { background: var(--color-gray-400); color: white; }

.element-details {
    flex: 1;
}

.element-name {
    font-weight: 600;
    color: var(--color-gray-800);
}

.element-meta {
    font-size: 0.75rem;
    color: var(--color-gray-600);
    display: flex;
    gap: 1rem;
    margin-top: 0.25rem;
}

.element-notes {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-gray-700);
}

.element-value {
    margin-top: 0.25rem;
    font-size: 0.875rem;
    font-family: monospace;
    color: var(--color-gray-700);
}

.element-badge {
    flex-shrink: 0;
}

.badge-met { background: var(--color-success); color: white; }
.badge-not_met { background: var(--color-danger); color: white; }
.badge-pending { background: var(--color-warning); color: white; }
.badge-na { background: var(--color-gray-400); color: white; }

.badge-status-active { background: var(--color-primary-light); color: var(--color-primary); }
.badge-status-complete { background: var(--color-success-light); color: var(--color-success); }
.badge-status-closed { background: var(--color-gray-200); color: var(--color-gray-600); }

.references ul {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
}

/* LLM Classification Styles (matching HAI detail page) */
.classification-item {
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
    background: var(--color-white);
}

.classification-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.confidence {
    font-weight: 600;
    color: var(--color-gray-700);
}

.classification-reasoning {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    background: var(--color-gray-50);
}

.classification-reasoning p {
    margin: 0.25rem 0 0 0;
    color: var(--color-gray-700);
}

.evidence {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    background: var(--color-gray-50);
}

.evidence-supporting {
    border-left: 3px solid var(--color-success);
}

.evidence-contradicting {
    border-left: 3px solid var(--color-danger);
}

.evidence-quotes {
    border-left: 3px solid var(--color-primary);
}

.evidence ul {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
}

.evidence ul li {
    margin-bottom: 0.5rem;
    line-height: 1.4;
}

.evidence-text {
    font-weight: 500;
    color: var(--color-gray-800);
}

.evidence-source {
    color: var(--color-primary);
    font-size: 0.8rem;
}

.classification-meta {
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-gray-200);
    color: var(--color-gray-500);
}

.text-muted {
    color: var(--color-gray-500);
}

.badge-success { background: var(--color-success); color: white; }
.badge-danger { background: var(--color-danger); color: white; }
.badge-warning { background: var(--color-warning); color: var(--color-gray-900); }
</style>
{% endblock %}
